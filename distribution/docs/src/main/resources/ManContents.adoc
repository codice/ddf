
This section provides instructions to install, start, and stop the {branding}.

=== Applications

{branding} is comprised of several modular applications, to be installed or uninstalled as needed.

{branding} Administrative Application::
The administrative application enhances administrative capabilities when installing and managing {branding}. It contains various services and interfaces that allow administrators more control over their systems.
{branding} Catalog Application::
The {branding} Catalog provides a framework for storing, searching, processing, and transforming information.
Clients typically perform query, create, read, update, and delete (QCRUD) operations against the Catalog.
At the core of the Catalog functionality is the *Catalog Framework*, which routes all requests and responses through the system, invoking additional processing per the system configuration.
{branding} Content Application::
The {branding} Content application provides a framework for storing, reading, processing, transforming and cataloging data.
{branding} Platform Application::
The Platform application is considered to be a core application of the distribution. The Platform application has fundamental building blocks that the distribution needs to run. +
These building blocks include subsets of: http://karaf.apache.org/[Karaf], http://cxf.apache.org/[CXF], http://karaf.apache.org/index/subprojects/cellar.html[Cellar], and http://camel.apache.org/[Camel]. +
Included as part of the Platform application is also a Command Scheduler.
The Command Scheduler allows users to schedule Command Line Shell Commands to run at certain specified intervals.

{branding} Security Application::
The Security application provides authentication, authorization, and auditing services for the {branding}. They comprise both a framework that developers and integrators can extend and a reference implementation that meets security requirements. More information about the security framework and how everything works as a single security solution can be found on the Managing Web Service Security page.
{branding} Solr Catalog Application::
The Solr Catalog Provider (SCP) is an implementation of the `CatalogProvider` interface using Apache Solr (http://lucene.apache.org/solr/) as a data store.
{branding} Spatial Application::
The {branding} Spatial Application provides KML transformer and a KML network link endpoint that allows a user to generate a View-based KML Query Results Network Link.
{branding} Standard Search UI::
The {branding} Standard Search UI application allows a user to search for records in the local Catalog (provider) and federated sources.
Results of the search are returned in HTML format and are displayed on a globe, providing a visual representation of where the records were found.

=== Installing {branding}

==== Prerequisites
* Supported platforms are *NIX - Unix/Linux/OSX, Solaris, and Windows.
* JDK8 must be installed (http://www.oracle.com/technetwork/java/javase/downloads/index.html).
* The JAVA_HOME environment variable must be set to the location where the JDK is installed.

.Example of Setting Up on *NIX
----
JAVA_HOME=/usr/java/jdk1.8.0
export JAVA_HOME
----

.Example of Setting Up JAVA_HOME on Windows
----
set JAVA_HOME=C:\Program Files\Java\jdk1.8.0
----

.*NIX
[WARNING]
====
Unlink `/usr/bin/java` if it is already linked to a previous version of the JRE:
`unlink /usr/bin/java`
====

[TIP]
====
Verify that the JAVA_HOME was set correctly.

.*NIX
----
echo $JAVA_HOME
----

.Windows
----
echo %JAVA_HOME%
----
====

* {branding} installation zip file.
* A web browser.
* For Linux systems, increase the file descriptor limit by editing `/etc/sysctl.conf` to include or change the following:

.File Descriptor Limit
----
fs.file-max = 6815744
----

.Restart
[WARNING]
====
For the change to take effect, a restart is required.
====

.Restart Command
----
init 6
----

[IMPORTANT]
====
The Admin Console is not compatible with Internet Explorer 9.
====

==== Installation Procedures

[TIP]
====
The *NIX commands listed next to the steps were performed on a default installation of Red Hat Enterprise Linux 5.4.
Permission maintenance is not mentioned in this article, but all files should be owned by the running user, regardless of platform.
====

.{branding} Installation Types
[NOTE]
====
{branding} can be installed using a single distribution zip file that contains all of the {branding} applications already installed,
OR
A custom {branding} installation can be performed by using the {branding} kernel distribution zip file then hot deploying the desired {branding} apps into the running {branding} kernel's <INSTALL_DIRECTORY>/deploy directory.
====

[IMPORTANT]
====
Although {branding} can be installed by any user, it is recommended for security reasons to have a non-root user execute the {branding} installation.
====

==== Use the {branding} Distribution Zip to Install
* After the prerequisites have been met, as a root user if for *NIX, change the current directory to the desired install location.
This will be referred to as <INSTALL_DIRECTORY>.

.*NIX Tip
[TIP]
It is recommended that the root user create a new install directory that can be owned by a non-root user (e.g., ddf-user).
The non-root user (e.g., ddf-user) can now be used for the remaining installation instructions.

.Example: Create a Directory and Switch User on *NIX
----
mkdir new_installation
chown ddf-user:ddf-group new_installation

su - ddf-user
----

* Change the current directory to location of zip file (ddf-X.Y.zip).

.Example: Where the Zip File may be Located in *NIX
----
cd /home/user/cdrom
----

.Windows (Example assumes {branding} has been downloaded to the D drive)
----
cd D:\
----
* Copy ddf-X.Y.zip to <INSTALL_DIRECTORY>.

.*NIX
----
cp ddf-X.Y.zip <INSTALL_DIRECTORY>
----

.Windows
----
copy ddf-X.Y.zip <INSTALL_DIRECTORY>
----

* Change the current directory to the desired install location.

.*NIX or Windows
----
cd <INSTALL_DIRECTORY>
----

* The {branding} zip is now located within the `<INSTALL_DIRECTORY>`. Unzip ddf-X.Y.zip.

.*NIX
----
unzip ddf-X.Y.zip
----

.Example: Use Java to Unzip in Windows
----
"C:\Program Files\Java\jdk1.8.0\bin\jar.exe" xf ddf-X.Y.zip
----

* Run {branding} using the appropriate script.

.*NIX
----
<INSTALL_DIRECTORY>/ddf-X.Y/bin/ddf
----

.Windows
----
<INSTALL_DIRECTORY>/ddf-X.Y/bin/ddf.bat
----
* Wait for the console prompt to appear.

.Command Prompt when Initially Loaded
----
ddf@local>
----

* The distribution takes a few moments to load depending on the hardware configuration.
Execute the following command at the command line for status:

.View Status
----
ddf@local>list
----

* Proceed to Configuration.

==== (Option 1/Preferred Method) Continue Setup and Installation Using the Admin UI Installer Module.

==== (Option 2/Part 1) Custom Installation Using the {branding} Kernel Distribution Zip

* After the prerequisites have been met, as a root user if for *NIX, change the current directory to the desired install location.
This will be referred to as `<INSTALL_DIRECTORY>`.

[NOTE]
====
It is recommended that the root user create a new install directory that can be owned by a non-root user (e.g., ddf-user).
The non-root user (e.g., ddf-user) can now be used for the remaining installation instructions.
====

.Example: Create a Directory and Switch User on *NIX
----
mkdir new_installation
chown ddf-user:ddf-group new_installation

su - ddf-user
----

* Change the current directory to the location of zip file (ddf-kernel-X.Y.zip).

.Example: Where the Zip File may be Located
----
cd /home/user/cdrom
----

.Windows (Example Assumes {branding} has been Downloaded to the D Drive)
----
cd D:\
----

* Copy ddf-kernel-X.Y.zip to <INSTALL_DIRECTORY>.

.*NIX
----
cp ddf-kernel-X.Y.zip <INSTALL_DIRECTORY>
----

.Windows
----
copy ddf-kernel-X.Y.zip <INSTALL_DIRECTORY>
----

* Change the current directory to the desired install location.

.*NIX or Windows
----
cd <INSTALL_DIRECTORY>
----

* The {branding} kernel zip is now located within the `<INSTALL_DIRECTORY>`.
Unzip `ddf-kernel-X.Y.zip`.

.*NIX
----
unzip ddf-kernel-X.Y.zip
----

.Example: Using Java to Unzip in Windows
----
"C:\Program Files\Java\jdk1.8.0\bin\jar.exe" xf ddf-kernel-X.Y.zip
----

* Configure global properties in <INSTALL_DIRECTORY>/etc/system.properties
.system.properties
----
org.codice.ddf.system.protocol=https://
org.codice.ddf.system.hostname=localhost
org.codice.ddf.system.httpsPort=8993
org.codice.ddf.system.httpPort=8181
org.codice.ddf.system.port=8993
org.codice.ddf.system.rootContext=/services

# Set the system information properties
org.codice.ddf.system.siteName=ddf.distribution
org.codice.ddf.system.siteContact=
org.codice.ddf.system.version=<latest version>
org.codice.ddf.system.organization=Codice Foundation
----

* If the {branding} Standalone Solr Server will be installed later, an additional configuration step is required for the {branding} kernel.
Add the following lines to the bottom of the `<INSTALL_DIR>/etc/org.ops4j.pax.web.cfg` file:

.Additional Configuration Step
----
# Jetty Configuration
org.ops4j.pax.web.config.file={karaf.home}/etc/jetty.xml
----

* Run the {branding} kernel using the appropriate script.

.*NIX
----
<INSTALL_DIRECTORY>/ddf-kernel-X.Y/bin/ddf
----

.Windows
----
<INSTALL_DIRECTORY>/ddf-kernel-X.Y/bin/ddf.bat
----

* Wait for the console prompt to appear.
.Command Prompt when Initially Loaded
----
ddf@local>
----
The distribution takes a few moments to load depending on the hardware configuration.
Execute the following command at the command line for status:

.View Status
----
ddf@local>list
----
The list of bundles should look similar to this:

.{branding} Kernel List of Apps Installed
----
ddf@local>list
START LEVEL 100 , List Threshold: 50
   ID   State         Blueprint      Spring    Level  Name
[ 111] [Active     ] [            ] [       ] [   80] Commons IO (2.1.0)
[ 112] [Resolved   ] [            ] [       ] [   80] DDF :: Distribution :: Web Console (2.3.0)
                                       Hosts: 76
[ 113] [Active     ] [Created     ] [       ] [   80] DDF :: Distribution :: Console Branding Plugin (2.3.0)
----

* Verify that the following {branding} kernel's features are installed by executing the `features:list` command and filtering for kernel distribution features:

.{branding} Kernel's Installed Features List
----
ddf@local>features:list | grep kernel
[uninstalled] [2.3.1-SNAPSHOT ] custom-karaf-bundles      kernel-2.3.1-SNAPSHOT Customized KARAF Bundles
[installed  ] [2.3.1-SNAPSHOT ] kernel-webconsolebranding kernel-2.3.1-SNAPSHOT DDF Web Admin Console branding
----

.{branding} Application Installation Dependencies
[WARNING]
====
Please read the installation instructions carefully for each {branding} application because some of the applications depend on other {branding} applications having been previously installed.

The order the {branding} applications are listed below is the recommended order of installation.
Each application must be active before installing the next application is installed.
The app:list console command can be used to verify the state of each app as it is installed.
====

* Install the Platform application by following the Platform Application Installation instructions.
* Install any optional applications that may be needed for the desired configuration.
** Catalog Application Installation instructions
** Security Application Installation instructions
** Content Application Installation instructions
** Spatial Application Installation instructions
** Solr Catalog Application Installation instructions are included in each of the Solr Catalog configurations. Refer to the appropriate section for the desired Solr Catalog Provider configuration's installation instructions.
*** Embedded Solr Catalog Provider
*** External Solr Catalog Provider
*** Standalone Solr Server
* Proceed to Configuration.

==== (Option 2/Part 2) Configuration
. Open a compatible web browser and log in to the Administrator Console (https://localhost:8993/admin) with username "admin" and password "admin" (no quotes).
. Select the Configuration tab in the Administrator Console.
.. Select Catalog Sorted Federation Strategy.
... In the Maximum start index field, enter the maximum query offset number or keep the default setting. Refer to Standard Catalog Framework for additional information.
... Select the Save button.

==== Verification
At this point, {branding} should be configured and running with a Solr Catalog Provider. New features (endpoints, services, and sites) can be added as needed.

Verification is achieved by checking that all of the {branding} bundles are in an Active state (excluding fragment bundles which remain in a Resolved state).

The following command displays the status of all the {branding} bundles:

.View Status
----
ddf@local>list | grep -i ddf
----
[WARNING]
====
If displayed, the *{branding} :: Distribution :: Web Console* entry should be in the *Resolved* state. This is expected. The {branding} Distribution Web Console is an OSGi bundle fragment. Bundle fragments are distinguished from other bundles in the command line console list by a new line under the its bundle status that states `Hosts`, followed by a bundle number. Bundle fragments remain in the *Resolved* state and can never move to the *Active* state.
====

.Example: Bundle Fragment in the Command Line Console
----
[ 261] [Resolved   ] [            ] [       ] [   80] DDF :: Distribution :: Web Console (2.2.0)
                                       Hosts: 76
----
[NOTE]
====
For a complete list of installed features/bundles see the {branding} Included Features document.
====

==== {branding} Directory Contents after Installation

During {branding} installation, the major directories shown in the table below are created, modified, or replaced in the destination directory.

[cols="1,8"]
|===

|Directory Name
|Description

|bin
|Scripts to start and stop {branding}

|data
|The working directory of the system – installed bundles and their data

|data/log/ddf.log
|Log file for {branding}, logging all errors, warnings, and (optionally) debug statements. This log rolls up to 10 times, frequency based on a configurable setting (default=1 MB)

|deploy
|Hot-deploy directory – KARs and bundles added to this directory will be hot-deployed (Empty upon {branding} installation)

|docs
|The {branding} Catalog API Javadoc

|etc
|Directory monitored for addition/modification/deletion of third party .cfg configuration files

|etc/ddf
|Directory monitored for addition/modification/deletion of {branding}-related .cfg configuration files (e.g., Schematron configuration file)

|etc/templates
|Template .cfg files for use in configuring {branding} sources, settings, etc., by copying to the etc/ddf directory.

|lib
|The system's bootstrap libraries. Includes the ddf-branding.jar file which is used to brand the system console with the {branding} logo.

|licenses
|Licensing information related to the system

|system
|Local bundle repository. Contains all of the JARs required by {branding}, including third-party JARs.

|===

=== Configuring
{branding} can be configured in several ways, depending on need.

==== Configuring via the Admin Console

===== Accessing the Admin Console
Open the admin portal.
* https://localhost:8993/admin
* Enter Username and Password.
[NOTE]
====
The default username/password in admin/admin. To change this, refer to Password Management page.
====

===== Initial Configuration
The first time the {branding} administrator portal runs, the initial configuration steps appear. Click Start to begin.

image::start.png[Start]

On the next screen, general configuration settings such as host address, port and site name can all be configured.

image::general_configuration_settings.png[General Configuration Settings]

Next, choose between a standard installation and a full installation. Individual applications can be added, removed or deactivated later

image::setup_types.png[Setup Types]

The final step of initial configuration is a display of all applications installed and their current status. This tree structure demonstrates how several applications depend on other applications.

[WARNING]
====
Platform App, Admin App, and Security Services App CANNOT be selected or unselected as it is installed by default and can cause errors if removed.
**Security Services App appears to be unselected upon first view of the tree structure, but it is in fact automatically installed with a later part of the installation process.
====

===== Viewing Currently Active Applications

====== Tile View
The first view presented is the Tile View, displaying all active applications as individual tiles.

image::tile_view.png[Tile View]

====== List View
Optionally, active applications can be displayed in a list format by clicking the list view button.

image::list_view.png[List View]

Either view has an > arrow to view more information about the application as currently configured.

====== Configuration
The Configuration tab lists all bundles associated with the application as links to configure any configurable properties of that bundle.

image::configuration_tab.png[Configuration Tab]

====== Details
The Details tab gives a description, version, status, and list of other applications that either required for , or rely on, the current application.

image::details_tab.png[Details Tab]

====== Features
The features tab breaks down the individual features of the application that can be installed or uninstalled as configurable features.

image::features_tab.png[Features Tab,]

===== Managing Applications
The Manage button enables activation/deactivation and adding/removing applications.

image::managing_applications.png[Manage]

====== Activating / Deactivating Applications
The Deactivate button stops individual applications and any dependent apps. Certain applications are central to overall functionality and cannot be deactivated. These will have the Deactivate button disabled. Disabled apps will be moved to a list at the bottom of the page, with an enable button to reactivate, if desired.

[IMPORTANT]
====
Deactivating the platform-app, admin-app, and security-services-app will cause errors within the system, so the capabilities to do so have been DISABLED.
====

====== Adding Applications
The Add Application button is at the end of the list of currently active applications.

====== Removing Applications
To remove an application, it must first be deactivated. This enables the Remove Application button.

====== Upgrading Applications

Each application tile includes an upgrade but to select a new version to install.

===== System Settings Tab
The configuration and features installed can be viewed and edited from the System tab as well, however, it is recommended that configuration be managed from the applications tab.

[IMPORTANT]
====
In general, applications should be managed via the applications tab.
Configuration via this page could result in an unstable system.
Proceed with caution!
====

==== Configuring {branding}

===== Configure {branding} Global Settings

Global configuration settings are configured via the properties file system.properties. These properties can be manually set by editing this file or set via the installer.

====== Configurable Properties

[cols="1,1,1,3,2,1"]
|===
|Title
|Property
|Type
|Description
|Default Value
|Required

|Protocol
|org.codice.ddf.system.protocol
|String
|Default protocol that should be used to connect to this machine.
|https://
|yes

|Host
|org.codice.ddf.system.hostname
|String
|The hostname or IP address used to advertise the system. Do not enter localhost. Possibilities include the address of a single node or that of a load balancer in a multi-node deployment.

NOTE: Does not change the address the system runs on.
|localhost
|yes

|Default Port
|org.codice.ddf.system.port
|String
|The default port used to advertise the system. This should match either the http or https port.

NOTE: Does not change the port the system runs on.
|8993
|yes

|HTTP Port
|org.codice.ddf.system.httpPort
|String
|The http port used by the system.

NOTE: This *DOES* change the port the system runs on.
|8181
|yes

|HTTPS Port
|org.codice.ddf.system.httpsPort
|String
|The https port used by the system.

NOTE: This *DOES* change the port the system runs on.
|8993
|yes

|Root Context
|org.codice.ddf.system.rootContext
|String
|The the base or root context that services will be made available under.
|/services
|yes

|Trust Store
|trustStore
|String
|The trust store used for SSL/TLS connections. Path is relative to ddf.home.
|etc/keystores/serverTruststore.jks
|yes

|Trust Store Password
|trustStorePassword
|String
|The password associated with the trust store.
|changeit (encrypted)
|yes

|Key Store
|keyStore
|String
|The key store used for SSL/TLS connections. Path is relative to karaf.home.
|etc/keystores/serverKeystore.jks
|yes

|Key Store Password
|keyStorePassword
|String
|The password associated with the key store.
|changeit (encrypted)
|yes

|Site Name
|id
|String
|The site name for {branding}.
|ddf.distribution
|yes

|Version
|version
|String
|The version of {branding} that is running.

This value should not be changed from the factory default.
|2.3.0
|yes

|Organization
|organization
|String
|The organization responsible for this installation of {branding}.
|Codice Foundation
|yes

|Site Contact
|site contact
|String
|The email address of the site contact.
|
|no

|===

===== Manage Features

{branding} includes many components, packaged as features, that can be installed and/or uninstalled without restarting the system. Features are collections of OSGi bundles, configuration data, and/or other features. For more information on the features that come with {branding}, including a list of the ones included, consult the {branding} Included Features page in the Software Version Description Document (SVDD).

.Transitive Dependencies
[NOTE]
====
Features may have dependencies on other features and will auto-install them as needed.
====

====== Install Features Using the Admin Console

. Open the admin console.
.. `https://localhost:8993/admin`
.. Enter Username and Password.
. Select the appropriate application.
. Select the Features tab.
. Select the play arrow under the Actions column for the feature that should be installed.
. Wait for the *Status* to change from *Uninstalled* to *Installed*.

====== Uninstall Features

. Open the Admin Console.
.. `https://localhost:8993/admin`
.. Enter Username and Password.
. Select the appropriate application.
. Select the stop icon under the Actions column for the feature that should be uninstalled.
. Wait for the *Status* to change from *Installed* to *Uninstalled*.

====== Add Feature Repositories

. Open the Admin Console.
.. `https://localhost:8993/admin`
.. Enter Username and Password
. Select the *Manage* button in the upper right.
. Select the Add an Application tile
. Upload a new .kar, .jar, or enter the URL of the feature repository (see below) to be added.
. Select the Maven URL tab
. Enter a valid URL for the feature repository
. Select the *Add URL* button.
. Select the *Save Changes* button.
. The new feature repository is added to the list of *Feature Repositories* above the URL field.

There are several ways a new feature repository can be discovered based on the URL entered:

* The URL can contain the fully qualified path to the feature repository, e.g., mvn:https://tools.codice.org/artifacts/content/groups/public/ddf-standard/2.2.0/xml/features. This URL can include the username and password credentials if necessary. e.g., mvn:https://user/password@tools.codice.org/artifacts/content/groups/public/ddf-standard/2.2.0/xml/features. Note that the password will be in clear text.
* The URL can only be the mvn URL, e.g., `mvn:ddf.features/ddf-standard/2.2/xml/features ddf-standard/2.2.0/xml/features`. The feature repositories configured for {branding} will be searched.

Repositories to be searched by {branding} can be configured in one of several ways:

* Set the org.ops4j.pax.url.mvn.repositories property in the `<DDF_INSTALL_DIR>/etc/org.ops4j.pax.url.mvn.cfg` file (most common).
* Set the org.ops4j.pax.url.mvn.settings property in the `<DDF_INSTALL_DIR>/etc/org.ops4j.pax.url.mvn.cfg` file to the maven `settings.xml` file that specifies the repository(ies) to be searched. A `settings.xml` template file for this configuration is provided in `<DDF_INSTALL_DIR>/etc/templates/settings.xml`
* Create a maven `settings.xml` file in the `<USER_HOME_DIR>/.m2` directory of the user running DDF that specifies the repository(ies) to be searched (this method is typical for a developer).
* The simplest approach is to specify the fully qualified URL to the feature repository.

==== Configuring {branding} Using the System Console
Follow these steps to configure {branding} using the system console.

[NOTE]
====
System Console instructions are provided in the Console Commands section.
====

===== Manage Features
{branding} includes many components, packaged as features, that can be installed and/or uninstalled without restarting the system. Features are collections of OSGi bundles, configuration data, and/or other features. For more information on the features that come with {branding}, including a list of the ones included, consult the {branding} Included Features page in the Software Version Description Document (SVDD).

.Transitive Dependencies
[NOTE]
====
Features may have dependencies on other features and will auto-install them as needed.
====

====== Install Features
. Determine which feature to install by viewing the available features on {branding}. +
`ddf@local>features:list`
. The console outputs a list of all features available (installed and uninstalled). A snippet of the list output is shown below (the versions may differ based on the version of {branding}being run):

----
State         Version          Name                          Repository  Description
[installed  ] [2.0.1         ] ddf-core                      ddf-2.1.0
[uninstalled] [2.0.1         ] ddf-sts                       ddf-2.1.0
[installed  ] [2.0.1         ] ddf-security-common           ddf-2.1.0
[installed  ] [2.0.1         ] ddf-resource-impl             ddf-2.1.0
[uninstalled] [2.0.1         ] ddf-source-dummy              ddf-2.1.0
----

. Install the desired feature. +
`ddf@local>features:install ddf-source-dummy`
. Check the feature list to verify the feature was installed. +
`ddf@local>features:list`

----
State         Version          Name                          Repository  Description
[installed  ] [2.0.1         ] ddf-core                      ddf-2.1.0
[uninstalled] [2.0.1         ] ddf-sts                       ddf-2.1.0
[installed  ] [2.0.1         ] ddf-security-common           ddf-2.1.0
[installed  ] [2.0.1         ] ddf-resource-impl             ddf-2.1.0
[installed  ] [2.0.1         ] ddf-source-dummy              ddf-2.1.0
----
. Check the bundle status to verify the service is started. +
`ddf@local>list`

The console output should show an entry similar to the following:
----
[ 117] [Active     ] [            ] [Started] [   75] DDF :: Catalog :: Source :: Dummy (<version>)
----

====== Uninstall Features
. Check the feature list to verify the feature is installed properly. +
`ddf@local>features:list`

----
State         Version          Name                          Repository  Description
[installed  ] [2.0.1         ] ddf-core                      ddf-2.1.0
[uninstalled] [2.0.1         ] ddf-sts                       ddf-2.1.0
[installed  ] [2.0.1         ] ddf-security-common           ddf-2.1.0
[installed  ] [2.0.1         ] ddf-resource-impl             ddf-2.1.0
[installed  ] [2.0.1         ] ddf-source-dummy              ddf-2.1.0
----

. Uninstall the feature. +
`ddf@local>features:uninstall ddf-source-dummy`

[WARNING]
====
Dependencies that were auto-installed by the feature are not automatically uninstalled.
====

. Verify that the feature has uninstalled properly. +
`ddf@local>features:list`

----
State         Version          Name                          Repository  Description
[installed  ] [2.0.1         ] ddf-core                      ddf-2.1.0
[uninstalled] [2.0.1         ] ddf-sts                       ddf-2.1.0
[installed  ] [2.0.1         ] ddf-security-common           ddf-2.1.0
[installed  ] [2.0.1         ] ddf-resource-impl             ddf-2.1.0
[uninstalled] [2.0.1         ] ddf-source-dummy              ddf-2.1.0
----

==== Configuring {branding} using Configuration (.cfg) files
The {branding} can also be configured with configuration (.cfg) files.

[IMPORTANT]
====
Since certain bundles can only be configured using the new `.config` file format, this new file format is now recommended. Please refer to the Configuring {branding} using Configuration (.config) Files section for more details.
====

==== HTTP Port Configuration
[IMPORTANT]
====
Do not use the Admin Console to change the HTTP port. While the Admin Console's Pax Web Runtime offers this configuration option, it has proven to be unreliable and may crash the system.
====

====== Multiple Local {branding} Nodes
Edit the port numbers in the files in the {branding} install folder. The line numbers relate to 2.1.X releases.

[cols="4" options="header"]
|===

|File to Edit
|Line Number
|Original Value
|Example of New Value

|bin/karaf.bat
|99
|5005
|i.e. 5006

|etc/org.apache.karaf.management.cfg
|27
|1099
|i.e. 1199

|" "
|32
|44444
|i.e. 44445

|etc/system.properties
|37
|8993
|i.e. 8994

|" "
|38
|8181
|i.e. 8281

|" "
|39
|8993
|i.e. 8994

|===

[WARNING]
====
Only root can access ports<1024 on Unix systems. For suggested ways to run {branding} with ports < 1024 see How do I use port 80 as a non-root user?.
====

==== Configuring {branding} using Configuration (.config) Files

The {branding} can also be configured using `.config` files. Like the Karaf `.cfg` files,
these configuration files must be located in the `<DDF_HOME>/etc/` directory, have a name that matches
the configuration persistence ID (PID) they represent and a `service.pid` property set to the
configuration PID.

As opposed to `.cfg` however, this type of configuration file supports lists within configuration values
(metatype `cardinality` attribute greater than 1).

[IMPORTANT]
====
This new configuration file format *must* be used for any configuration that makes use of lists.
Examples include Web Context Policy Manager (PID: `org.codice.ddf.security.policy.context.impl.PolicyManager`)
and Security STS Guest Claims Handler (PID: `ddf.security.sts.guestclaims`).
====

[WARNING]
====
Only one configuration file should exist for any given PID. The result of having both a `.cfg` and
a `.config` file for the same PID is undefined and could cause the application to fail.
====

The main purpose of the configuration files is to allow administrators to pre-configure {branding}
without having to use the admin console. In order to do so, the configuration files need to be
copied to the `<DDF_HOME>/etc` directory after {branding} zip has been extracted.

Upon start up, all the `.config` files located in `<DDF_HOME>/etc` are automatically read and processed.
Files that have been processed successfully are moved to `<DDF_HOME>/etc/processed` so they will not
be processed again when the system is restarted. Files that could not be processed are moved to the
`<DDF_HOME>/etc/failed` directory.

{branding} also monitors the `<DDF_HOME>/etc` directory for any new `.config` file that gets added.
As soon as a new file is detected, it is read, processed and moved to the appropriate directory based on
whether it was successfully processed or not.

===== Configuring Managed Service Factory Bundles

Services that are created using a Managed Service Factory can be configured using `.config` files as well.
The configuration files follow a different naming convention however. The files must start with the
Managed Service Factory PID, be followed by a unique identifier and have a `.config`
extension. For instance, assuming that the Managed Service Factory PID is `org.codice.ddf.factory.pid`
and two instances of the service need to be configured, files `org.codice.ddf.factory.pid.uniqueID1.config`
and `org.codice.ddf.factory.pid.uniqueID2.config` should be created and added to `<DDF_HOME>/etc`.

The unique identifiers used in the file names have no impact on the order in which the configuration files are
processed. No specific processing order should be assumed. Also, a new service will be created
and configured every time a configuration file matching the Managed Service Factory PID is added
to the directory, regardless of the number used.

These configuration files must also contain a `service.factoryPid` property set to the factory PID
(without the sequential number). They should not however contain the `service.pid` property.

===== File Format

The basic syntax of the `.config` configuration files is similar to the older `.cfg` files but introduces
support for lists and types other than simple strings. The type associated with a property must match
the `type` attribute used in the corresponding `metatype.xml` file when applicable.

The following table shows the format to use for each property type supported.

[cols="1,2,4" options="header"]
|===

|Type
|Format
|Example

|Service PID
|`service.pid` = "servicePid"
|`service.pid = "org.codice.ddf.security.policy.context.impl.PolicyManager"`

|Factory PID
|`service.factoryPid` = "serviceFactoryPid"
|`service.factoryPid = "Csw_Federated_Source"`

|Strings
|`name = "value"`
|`name = "john"`

|Booleans
|`name = B"true\|false"`
|`authorized = B"true"`

|Integers
|`name = I"value"`
|`timeout=I"60"`

|Longs
|`name = L"value"`
|`diameter = L"10000"`

|Floats
|`name = F"value"`
|`cost = F"10.50"`

|Doubles
|`name = D"value"`
|`latitude = D"45.0234"`

|Lists of Strings
|`name = [ "value1", "value2", ... ]`
|`authenticationTypes = [ "/\=SAML\|GUEST", "/admin\=SAML\|basic", "/jolokia\=SAML\|basic", "/system\=basic", "/solr\=SAML\|PKI\|basic", "/sources\=SAML\|basic", "/security-config\=SAML\|basic" ]`

|Lists of Integers
|`name = I[ "value1", "value1", ... ]`
|`sizes = I[ "10", "20", "30" ]`

|===

[NOTE]
====
* Lists of values can be prefixed with any of the supported types (`B`, `I`, `L`, `F` or `D`)
* To prevent any configuration issues, the `=` signs used in values should be escaped using `\`
* Boolean values will default to `false` if any value other than `true` is provided
====

.Sample configuration file
----
service.pid="org.codice.ddf.security.policy.context.impl.PolicyManager"

authenticationTypes=["/\=SAML|GUEST","/admin\=SAML|basic","/jolokia\=SAML|basic","/system\=basic","/solr\=SAML|PKI|basic","/sources\=SAML|basic","/security-config\=SAML|basic","/search\=basic"]

realms=["/\=karaf"]

requiredAttributes=["/\=","/admin\={http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role\=admin}","/solr\={http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role\=admin}","/jolokia\={http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role\=admin}","/system\={http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role\=admin}","/security-config\={http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role\=admin}"]

whiteListContexts=["/services/SecurityTokenService","/services/internal/metrics","/services/saml","/proxy","/services/csw"]
----

==== Enable and Configure HTTP to HTTPS Proxy

What it does: This feature proxies http to https.

When to use: Use this feature when you have legacy clients that can’t use HTTPS and you do not want HTTP enabled for the entire container via the etc/org.ops4j.pax.web.cfg file.


===== How to install this feature using the DDF terminal:
	Note: If DDF has not been installed, use the “How to install this feature using the Admin Console” guide found below

1.) Launch the DDF application.

2.) In the DDF console, type the command “features:install platform-http-proxy”

===== How to install this feature using the Admin Console:


1.) Navigate your browser to https://localhost:8993/admin/index.html. The admin console appears.

1.a) If this is not a new install, skip to step 11

2.) At the admin console, click on “Start” to begin the setup process. The guest attributes page will appear.

3.) Configure the guest attributes with any attributes that you want *EVERY* user to have.

4.) Click “Next” and the “Setup Types” page appears.

5.) Choose whichever setup type that corresponds to the suite of applications you would like installed.

6.) [Optional] Click “Customize” and a window appears allowing you to customize which features will be included in your installation.

7.) Click “Next” and the application installation begins

8.) Configure the system configuration settings by entering in values for the “Host”, “HTTP Port”, “HTTPS Port”, “Site Name”, “Site Contact”, "Version", and “Organization.” Descriptions for these settings can be found on the “System configuration settings” page. If the hostname is changed from localhost, a trust/key store must be provided with the correct certificates.

9.) Click “Next” and the system installation begins. If the hostname or ports were changed, you will be redirected to the location of the Admin Console

10.) Once the installation is finished, click “Finish” to conclude the setup and the page will refresh.

11) On the left hand side of the screen, select the “Applications” tab.

12.) Under “Active Applications” click the “DDF Platform” application tile. This will bring up the configuration page for the DDF Platform application. This arrow is shown here circled in red:

image::platform_circled.png[Platform Circled]

13.) Under the “DDF Platform” heading, choose the “Features” tab. The features tab shows us all the features we can install to the currently selected app.

14.) Scroll through the list of features and find “platform-http-proxy.” The feature will be listed as “Uninstalled” click on the *Play* button to the right of the word “Uninstalled” in order to install the platform-http-proxy. This *Play* button is shown here circled in red:

image::proxy_install_circled.png[Proxy Install Button Circled]

==== Configuring the proxy:
Note: The hostname should be set by default. Only configure the proxy if this is not working.


1.) Navigate your browser to https://localhost:8993/admin/index.html. The admin console appears.

2.) On the left hand side of the screen, select the “Applications” tab.

3.) Under “Active Applications” click the “DDF Platform” application tile. This will bring up the configuration page for the DDF Platform application. This arrow is shown here circled in red:

image::platform_circled.png[Platform Circled]

4.) Under the “DDF Platform” heading, ensure that the “Configuration” tab is selected.

5.) Under the “Name” heading, select “HTTP to HTTPS Proxy Settings” and the settings menu appears.

6.) Under “Hostname”, enter in the Hostname to use for HTTPS connection in the proxy.

7.) Click “Save changes” to save the Hostname.

===== Enable SSL for Clients

In order for outbound secure connections (HTTPS) to be made from components like Federated Sources and Resource Readers configuration may need to be updated with keystores and security properties. These values are configured in the <{branding}_INSTALL_DIR>/etc/system.properties file. The following values can be set:

[cols="3" options="header"]
|===

|Property
|Sample Value
|Description

|javax.net.ssl.trustStore
|	etc/keystores/serverTruststore.jks
|The java keystore that contains the trusted public certificates for Certificate Authorities (CA's) that can be used to validate SSL Connections for outbound TLS/SSL connections (e.g. HTTPS).
When making outbound secure connections a handshake will be done with the remote secure server and the CA that is in the signing chain for the remote server's certificate must be present in the trust store for the secure connection to be successful.

|javax.net.ssl.trustStorePassword
|changeit
|This is the password for the truststore listed in the above property

|javax.net.ssl.keyStore
|etc/keystores/serverKeystore.jks
|The keystore that contains the private key for the local server that can be used to signing and encryption.
This must be set if establishing outgoing 2-way (mutual) SSL connections where the local server must also present it's certificate for the remote server to verify.

|javax.net.ssl.keyStorePassword
|changeit
|The password for the keystore listed above

|javax.net.ssl.keyStoreType
|jks
|The type of keystore

|https.cipherSuites
|TLS_DHE_RSA_WITH_AES_128_CBC_SHA, +
TLS_DHE_RSA_WITH_AES_128_CBC_SHA, +
TLS_DHE_DSS_WITH_AES_128_CBC_SHA, +
TLS_RSA_WITH_AES_128_CBC_SHA
|The cipher suites that are supported when making outbound HTTPS connections

|https.protocols
|TLSv1.1,TLSv1.2
|The protocols that are supported when making outbound HTTPS connections

|===

==== Configuring {branding} with New Certificates
{branding} ships with a default security certificate configured to identify the {branding} instance machine as "localhost."
This allows the {branding} distribution to be unzipped and run immediately in a secure manner.
If the installer was used to install the {branding} and a hostname other than "localhost" was given, the user will be prompted to upload new trust/key stores.
If the hostname was left as 'localhost' or the hostname was changed after installation, in order to access the {branding} instance from another machine over HTTPS (now the default for many services) the default certificates need to be replaced with a certificate that uses the fully qualified hostname of the server running the {branding} instance.

==== Important Terms

[cols="3" options="header"]
|===

|Term
|Definition
|Example

|{branding}_HOME
|The path to the unzipped {branding} distribution
|/opt/ddf/ddf-2.9.0

|alias
|The nickname given to a certificate within a keystore to make it easily identifiable.
Normally, the alias should be the {branding} instance's FQDN.

|localhost

|certificate
|A combination of an entity's identity information with the entity's public key.
The entity can be a person, organization, or something else, but in this case the entity is a computer on the network.
To be valid, a certificate must be digitally (cryptographically) signed by a certificate authority.
By signing a certificate, the CA attests that the public key truly belongs to the entity and no one else.
See also PKIX.
|<FQDN>.crt

|CN
|Common Name - The FQDN of the {branding} instance as defined within the Certificate.
|search.codice.org

|certification path
|A list of certificates, starting with the server's certificate and followed certificate of the CA who signed the server's CSR.
The list of certificates continues, with each subsequent certificate belonging to the CA that signed the current CA's certificate.
This chain continues until it reaches a trusted anchor, or root CA certificate.
The chain establishes a link between the trust anchor and the server's certificate.
See IETF RFC 4158 for details.
|

|chain of trust
|See certification path.
|

|CSR
|Certificate Signing Request.
A certificate that has not yet been signed by a certificate auhority.
|<FQDN>.csr

|digital certificate
|See *certificate*.
|

|FQDN
|Fully Qualified Domain Name
|search.codice.org

|HTTPS
|Hyper-Text Transfer Protocol Secure.
An encrypted alternative to HTTP.
The HTTP connection is encrypted over TLS.
See IETF RFC 2818 for more information.
|https://

|JKS
|Java *keystore*.
A dictionary of cryptographic objects (e.g. private keys, certificates) referenced by an *alias*.
The JKS format is specific to Java.
|

|keystore
|Refers to either a JKS keystore or a PKCS#12 keystore.
For the purposes of these instructions a keystore is always a file.
|

|keytool
|The Java keytool is a key and certificate management command line utility.
|

|openssl
|The openssl program is a command line tool for using the various cryptography functions of OpenSSL's crypto library from the shell.
|

|PKCS#12
|Personal Information Exchange Syntax.
A standard that allows certificates, private keys, and optional attributes to be combined into a single file.
See IETF RFC 7292 for more information.
|<FQDN>.p12

|PKIX
|A public key infrastructure also known as X.509.
It is documented in the IEFT RFC 5280 and defines what a *certificate* is.
|

|PORT
|TCP Port of service
|8993

|security certificate
|See *certificate*.
|

|TLS
|Transport Layer Security protocol.
Provides privacy and data integrity between client and server.
See IETF RFC 5246 for more information.
|

|===

==== Update {branding} Configuration

===== Configure {branding} Web Service Providers
By default Solr, STS server, STS client and the rest of the services use the system property 'org.codice.ddf.system.hostname' which is defaulted to 'localhost' and not to the fully qualified domain name of the {branding} instance.
Assuming the {branding} instance is providing these servcies, the configuration must be updated to use the {branding} instance's *fully qualified domain name* as the service provider.

This can be done by editing the system.properties in <INSTALL_DIRECTORY>/etc/ or during the installer at https://localhost:8993/admin

. Start the {branding} instance, if it is not already running.
. Go to https://localhost:8993/admin and step through the installer setting the hostname to the instance's FQDN and the port to correct value.
.. If the hostname is changed during the install to something other than `localhost` a new keystore and truststore must be provided
.. When changing the hostname for testing or development purposes, the installer can be started with a ?dev=true URL query parameter. This will cause the system to automatically generate self signed certificates for any hostname that is entered during the install process.

===== Configure Files in HOME Directory Hierarchy

[IMPORTANT]
====
The passwords configured in this section reflect the passwords used to decrypt JKS (Java KeyStore) files.
Changing these values without also changing the passwords of the JKS causes undesirable behavior.
====
* In `<DDF_HOME>/etc/user.properties`, modify the line:
----
localhost=localhost,group,admin,manager,viewer,webconsole,system-admin
----
To be:
----
<FQDN>=<PASSWORD>,group,admin,manager,viewer,webconsole,system-admin
----

* Next ,configure `<DDF_HOME>/etc/system.properties`
[source,bash]
----
#START DDF SETTINGS
# Set the keystore and truststore Java properties
javax.net.ssl.keyStore=etc/keystores/serverKeystore.jks
javax.net.ssl.keyStorePassword=<NewPassword>
javax.net.ssl.trustStore=etc/keystores/serverTruststore.jks
javax.net.ssl.trustStorePassword=<NewPassword>
javax.net.ssl.keyStoreType=jks

# Set the global url properties
org.codice.ddf.system.protocol=https://
org.codice.ddf.system.hostname=<FQDN>
org.codice.ddf.system.httpsPort=8993
org.codice.ddf.system.httpPort=8181
org.codice.ddf.system.port=8993
org.codice.ddf.system.rootContext=/services

# HTTPS Specific settings. If making a Secure Connection not leveraging the HTTPS Java libraries and
# classes (e.g. if you are using secure sockets directly) then you will have to set this directly
https.cipherSuites=TLS_DHE_RSA_WITH_AES_128_CBC_SHA,TLS_DHE_RSA_WITH_AES_128_CBC_SHA,TLS_DHE_DSS_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA
https.protocols=TLSv1.1,TLSv1.2
----

===== Creating and Installing Keys and Certificates

To create a private key and certificate signed by the Demo Certificate Authority, use the provided scripts.
To use the scripts, run them out of the <DDF_HOME>/etc/certs directory. For *NIX, use the CertNew.sh script.

----
sh CertNew.sh <FQDN>
----

The above command creates a new entry in the keystore for a server named my.server.com.
To create and install the certificates on Windows, use the CertNew.cmd file in the same directory.

----
CertNew <FQDN>
----

To install a certificate signed by a different Certificate Authority, see <<Import into a Java Keystore (JKS)>>.

===== Restart and Test
Finally, restart the {branding} instance. Browse the Admin UI at https://<FQDN>:8993/admin to test changes.

[WARNING]
====
If the server's fully qualified domain name is not recognized, the name may need to be added to the network's DNS server.
====

[TIP]
====
The {branding} instance can be tested even if there is no entry for the FQDN in the DNS. First, test if the FQDN is already recognized. Execute this command:
----
ping <FQDN>
----
If the command responds with an error message such as unknown host, then modify the system's *hosts* file to point the server's FQDN to the loopback address. For example:
----
127.0.0.1    <FQDN>
----

====

[NOTE]
====
By default, the Catalog Backup Post-Ingest Plugin is *NOT* enabled. To enable, the Enable Backup Plugin configuration item must be checked in the Backup Post-Ingest Plugin configuration.

Enable Backup Plugin: true

====

[IMPORTANT]
====
The Embedded LDAP has hard-coded values for the keystore path, truststore path, keystore password, and truststore password (`https://github.com/codice/opendj-osgi/blob/d5021cbac4db831467ceb109ffd7ffd2c734dcd4/embedded/opendj-embedded-server/src/main/resources/config/config.ldif`). So if you are using a non-default keystore and non-default truststore the Embedded LDAP will not work. You will see errors in `<ddf-home>/etc/org.codice.opendj/ldap/logs/errors` similar to the one below:

`21/Jan/2015:08:58:57 -0700] category=CORE severity=NOTICE msgID=458891 msg=The Directory Server has sent an alert notification generated by class org.opends.server.protocols.ldap.LDAPConnectionHandler (alert type org.opends.server.LDAPHandlerDisabledByConsecutiveFailures, alert ID 2425016):  The LDAP connection handler defined in configuration entry cn=LDAP Connection Handler,cn=Connection Handlers,cn=config has experienced consecutive failures while trying to accept client connections:  An error occurred while attempting to initialize the SSL context for use in the LDAP Connection Handler:  An error occurred while trying to load the keystore contents from file ../../keystores/serverKeystore.jks:  IOException(Keystore was tampered with, or password was incorrect) (id=1310782) (LDAPConnectionHandler.java:1324 LDAPConnectionHandler.java:1255 LDAPConnectionHandler.java:1091 LDAPConnectionHandler.java:974).  This connection handler will be disabled`

A workaround is to modify `config.ldif` as seen in the steps below and hot deploy `opendj-embedded-app-<version>.kar.`
====

** The default password in `config.ldif` for `serverKeystore.jks` is `changeit`.  This needs to be modified.
*** `ds-cfg-key-store-file: ../../keystores/serverKeystore.jks`
*** `ds-cfg-key-store-type: JKS`
*** `ds-cfg-key-store-pin: password`
*** `cn: JKS`
** The default password in `config.ldif` for `serverTruststore.jks` is `changeit`.  This needs to be modified.
*** `ds-cfg-trust-store-file: ../../keystores/serverTruststore.jks`
*** `ds-cfg-trust-store-pin: password`
*** `cn: JKS`

==== Configuring DDF to use an LDAP server

[WARNING]
====
The configurations for Security STS LDAP and Roles Claims Handler and Security STS LDAP Login contain plain text default passwords for the embedded LDAP, which is insecure to use in production.
====

Use the encryption service, described in <<Encryption Service>>, on the command line to set passwords for your LDAP server.
Then change the LDAP Bind User Password in the configurations to use the encrypted password.

==== Configuring Solr Catalog Provider

===== Configure the Solr Catalog Provider Data Directory
The Solr Catalog Provider writes index files to the file system. By default, these files are stored under `$DDF_HOME/data/solr/catalog/data`.  If there is inadequate space in `$DDF_HOME`, or if it is desired to maintain backups of the indexes only, this directory can be changed.

In order to change the Data Directory, the `system.properties` file in `$DDF_HOME/etc` must be edited prior to starting {branding}.

.Edit the system.properties file
[source,bash,linenums]
----
# Uncomment the following line and set it to the desired path
#solr.catalog.data.dir=/opt/solr/catalog/data
----

===== Changing the Data Directory after {branding} has ingested data

. Shut down {branding}.
. Create the new directory to hold the indexes.
+
.Make new Data Directory
[source,bash]
----
mkdir /path/to/new/data/dir
----
+
. Copy the indexes to the new directory.
+
.Copy the indexes to the new Directory.
[source,bash]
----
cp /path/to/old/data/dir/* /path/to/new/data/dir/.
----
+
. Set the system.properties file to use the new directory.
+
.Set the SOLR_CATALOG_DATA_DIR
[source,bash]
----
solr.catalog.data.dir=/path/to/new/data/dir
----
+
. Restart {branding}.

==== Configuring {branding} Application and Configuration Clustering

An essential part to the {branding} Clustering solution is the ability to manage applications and configurations among cluster nodes. The following documentation will help in setting up a set of {branding} server nodes in a cluster, and allow an administrator to manage the applications and configurations that are deployed.

===== Set Up {branding} Cluster

====== Initial Setup

The goal of the {branding} Cluster solution is to keep applications and configurations synchronized on every {branding} server. When setting up a {branding} server, it is recommended that only one server is setup per machine (virtual or non-virtual). This means that for each physical machine or virtual machine (VM) that is setup, only one instance of the {branding} is deployed on it. This configuration provides the least complexity in configuration of the {branding} Cluster and allows the {branding} server itself to utilize the resources of the entire system. It is also recommended that all {branding} servers and systems be configured the same. This means that all {branding} server platforms have the same configurations and applications running initially. Also, ensure that all physical and virtual systems running the {branding} servers have the same configuration (e.g., operating system, memory, CPU, etc.).

====== Start and Configure New {branding} Server Node Clusters
Before starting your {branding} cluster nodes, you must first setup your node network configurations. See the Configuring {branding} Clustering For Multicast & Unicast section for more information. To view all of the available nodes, navigate in your browser to the {branding} Admin Console (https://localhost:8993/admin) and click on the tab labeled “Clustered Groups”. Under the group “default”, you should see all running {branding} nodes that have been clustered. It is also possible to move all instances into a named group. In order to perform this action, you must have access to one of the {branding} command line shells directly.

[source,bash]
----
features:install cellar
----
The first action that will be performed is the creation of a new group. To create a new cluster group named “mygroup”, execute the following command:

[source,bash]
----
cluster:group-create mygroup
----
This command will create a new cluster group which will not contain any nodes. Execute the following command to view all groups:

[source,bash]
----
cluster:group-list
----
You should see the following output:

[source,bash]
----
Group Members
* [default ] [192.168.1.110:5701* ]
[mygroup ] []
----

As you can see, there are now two groups, the default group and the new group that you have just created.
We now need to move the {branding} node out of the “default” group and into “mygroup”.
Execute the following commands:

[source,bash]
----
cluster:group-join mygroup 192.168.1.110:5701

cluster:group-quit default 192.168.1.110:5701
----

The first command allows the {branding} node to join the new group.
The second command removes the {branding} node from the “default” group.

[source,bash]
----
Group Members
[default ] []
* [mygroup ] [192.168.1.110:5701* ]
----
These commands should be executed on all “production” nodes located in the default group.
Note: The default group will always remain and cannot be deleted.
It is possible for {branding} nodes to be separated into multiple groups.
It is also possible for one {branding} node to exist in multiple groups.
These are advanced topics and can be addressed in additional documentation links.

===== Add a {branding} Server Node to the Cluster
There may be a need for an additional {branding} server node after an existing {branding} cluster has already been configured and deployed.
It is important that when adding additional nodes, the new node must match the existing nodes in terms of applications and configurations.
Therefore it is good practice to copy one of the existing nodes and push that copy to a new virtual machine or server machine instance.
This will provide a stabler transition of the new node into the cluster.
Once you have setup the new node, you can follow the instructions above to add the new node into the cluster group, if needed.

==== Manage Applications

Application management within the cluster has been designed to function as if you were only managing one instance of {branding}.
All {branding} applications are handled at the feature level.
Therefore, the Features section of the Admin Console can be used to manage all applications within the {branding} Cluster.
The Features section of the Admin Console can be accessed by navigating to \https://localhost:8993/admin in a web browser.
From here you can select the System tab on the left and then the Features tab at the top to see a list of every feature available on the system.
Credentials may be required (username and password) to access the console.

From the System -> Features page, the following functions are available:

* Provide a listing of the available features and repositories in the cluster
* Install features from repositories into the cluster
* Uninstall or remove features from the cluster

==== Manage Configurations

Just as with Application Management, managing configurations within a cluster was designed to function as if you were configuring one instance of {branding}.
There are two areas where {branding} configurations can be modified.
Most modifications will occur within the Configurations section of the Admin Console.
The Admin Console can be accessed by navigating to https://localhost:8993/admin in a web browser.
Credentials may be required (username and password) to access the console.

From the Applications tab, the following features are available:

* Provide a listing of the installed applications
* Install applications
* Uninstall applications
* Add new applications
* Upgrade existing applications
* Edit configurations for applications

For more information on using the console, refer to the {branding} User's Guide.

===== Control Feature and Configuration Synchronization

There may be instances where certain configurations are to remain local to a certain {branding} node.
This behavior can be controlled through the cellar groups configuration.
To open this configuration, navigate to Within the configuration list, search for the configuration with name “org.apache.karaf.cellar.groups”.
Click on the configuration to view / edit.
Within the file you will see many configurations listed with the following format:

[source,bash]
----
[cluster group name] . [configuration type (e.g. feature, configuration, etc.)]. [list type] = [values]
----

These configurations allow you to control the synchronization of features and configurations through blacklists and whitelists.
If you do not want a specific feature or configuration to propagate throughout your cluster group, you can put it into a blacklist.
By default for all cluster groups, all features are in the white list:

[source,bash]
----
mygroup.features.whitelist.outbound = *
----
with the exception of “`cellar`”:

[source,bash]
----
mygroup.features.blacklist.outbound = cellar
----

As for configurations, by default all configurations are whitelisted with the exception of the following:

[source,bash]
----
mygroup.config.blacklist.outbound = org.apache.felix.fileinstall*, org.apache.karaf.cellar.groups, org.apache.karaf.cellar.node, org.apache.karaf.management, org.apache.karaf.shell, org.ops4j.pax.logging
----

Once you have made your changes, you can save the configuration by pressing the *Save* button.

==== Additional Details

===== Configure {branding} Clustering for Unicast and Multicast
By default, {branding} clustering utilizes TCP-IP unicast for discovering other {branding} nodes.
The hazelcast.xml file located under <{branding} root>/etc/ contains the port and address configurations for network setup.
The TCP-IP unicast mode has been setup to allow for manual configuration and control of initial clustering.
This configuration is also beneficial for cases where a particular network cannot support multicast or multicast has been turned off.
There is a configuration which allows auto-discovery of {branding} nodes and utilizes multicast as a transport.
The hazelcast.xml file is configured like the following to allow for TCP-IP unicast discovery of cluster nodes:

[source,xml,linenums]
----
<join>
	<multicast enabled="false">
		<multicast-group>224.2.2.3</multicast-group>
		<multicast-port>54327</multicast-port>
	</multicast>
	<tcp-ip enabled="true">
		<interface>127.0.0.1</interface>
	</tcp-ip>
	<aws enabled="false">
		<access-key>my-access-key</access-key>
		<secret-key>my-secret-key</secret-key>
		<region>us-east-1</region>
	</aws>
</join>
----

As you can see, the multicast option has been set to false and the tcp-ip option is set to true.
All systems that will participate in the cluster need to have their ip addresses listed within the interface section highlighted.
These modifications must be made for each node.
Once these modifications have been made to the hazelcast.xml file, it is recommended that the nodes be restarted.
The following hazelcast.xml configuration would be used for multicast auto-discovery:

[source,xml,linenums]
----
<join>
	<multicast enabled="true">
		<multicast-group>224.2.2.3</multicast-group>
		<multicast-port>54327</multicast-port>
	</multicast>
	<tcp-ip enabled="false">
		<interface>127.0.0.1</interface>
	</tcp-ip>
	<aws enabled="false">
		<access-key>my-access-key</access-key>
		<secret-key>my-secret-key</secret-key>
		<region>us-east-1</region>
	</aws>
</join>
----

As you can see, the multicast option has been set to true and the tcp-ip option is set to false.
A multicast group and port can be specified in the file as highlighted above.
These modifications must be made for each node.
Once these modifications have been made to the hazelcast.xml file, it is recommended that the nodes be restarted.

===== Verify Synchronized {branding} Nodes

In most cases, the {branding} system console should provide you with a listing of all features, repositories, and configurations that are installed on the cluster.
There are times when the cluster can become out of sync.
This instance may occur if a system has been offline for some time.
One way to verify the synchronized lists of the cluster is to run cluster commands from the command line.
In order to perform these actions, you must have access to one of the {branding} command line shells directly.
Once at the command line, execute the following command to see the list of deployed features for your cluster:

[source,bash]
----
cluster:feature-list mygroup
----

This command will list the available features for your cluster group “mygroup”.

[source,bash]
----
Features for cluster group mygroup
Status Version Name
[installed ] [2.2.0 ] catalog-opensearch-endpoint
......
----
To view the cluster group's configurations, execute the following command:

[source,bash]
----
cluster:config-list mygroup
----
This command will show all shared configurations among the cluster group “mygroup”.

[source,bash]
----
----------------------------------------------------------------
Pid: org.ops4j.pax.url.mvn
Properties:
org.ops4j.pax.url.mvn.useFallbackRepositories = false
service.pid = org.ops4j.pax.url.mvn
org.ops4j.pax.url.mvn.disableAether = true
----------------------------------------------------------------
Pid: org.apache.karaf.webconsole
Properties: ....
----

The following command will list all repositories associated with the cluster group “mygroup”:

[source,bash]
----
cluster:features-url-list mygroup
The following will be displayed:
mvn:org.apache.cxf.karaf/apache-cxf/2.7.2/xml/features
mvn:org.apache.activemq/activemq-karaf/5.6.0/xml/features
mvn:ddf.catalog.kml/catalog-kml-app/2.1.0/xml/features
mvn:ddf.mime.tika/mime-tika-app/1.0.0/xml/features
----
If for any reason, any of the lists above do not match the list of features, repositories, or configurations found in the {branding} system consoles, the following command can be executed:

[source,bash]
----
cluster:sync
----

This command should allow for a {branding} node to be synchronized with the rest of the cluster.

==== Check for Active Nodes

Checking whether a node is active or not can be done utilizing the node ping command.
In order to use this command you must have access to one of the the {branding} command line shells.
A list of nodes can be shown by executing the following command:

[source,bash]
----
cluster:node-list
----
The command should show the following output:

[source,bash]
----
ID Host Name Port
* [192.168.1.110:5701 ] [192.168.1.110 ] [ 5701]
----

The output will show the ID, host name, and port of each active {branding} node in the cluster.
The asterisk shows which node you are currently accessing the shell on.
Now that you have a listing of node IDs, you can use these to ping other nodes.
Execute the following command:

[source,bash]
----
cluster:node-ping
----

The following result will print out until you press ctrl-c:
[source,bash]
----
PING 192.168.1.110:5701
from 1: req=192.168.1.110:5701 time=9 ms
from 2: req=192.168.1.110:5701 time=4 ms
from 3: req=192.168.1.110:5701 time=2 ms
from 4: req=192.168.1.110:5701 time=3 ms
from 5: req=192.168.1.110:5701 time=4 ms
from 6: req=192.168.1.110:5701 time=2 ms
from 7: req=192.168.1.110:5701 time=2 ms
^C
----

The output will provide you with a typical ping result showing connectivity and response times.

==== Configuring Notifications

Notifications are messages that are sent to clients to inform them of some significant event happening in {branding}.
Clients must subscribe to a {branding} notification channel to receive these messages.

===== Usage
{branding} notifications are currently being utilized in the {branding} Catalog application for resource retrieval.
When a user initiates a resource retrieval via the {branding} Standard Search UI, {branding} opens the channel `/ddf/notification/catalog/downloads`, where notifications indicating the progress of that resource download are sent.
Any client interested in receiving these progress notifications must subscribe to that channel.
When {branding} starts downloading the resource to the client that requested it, a notification with a status of "Started" will be broadcast.
If the resource download fails, a notification with a status of "Failed" will be broadcast.
Or, if the resource download is being attempted again after a failure, "Retry" will be broadcast.

When a notification is received, {branding} Standard UI displays a popup containing the contents of the notification, so a user is made aware of how their downloads are proceeding.

Behind the scenes, the {branding} Standard Search UI invokes the REST endpoint to retrieve a resource.
In this request, it adds the query parameter "user" with the CometD session ID or the unique User ID as the value.
This allows the CometD server to know which subscriber is interested in the notification.
For example, \http://{branding}_HOST:8993/services/catalog/sources/ddf.distribution/2f5db9e5131444279a1293c541c106cd?transform=resource&user=1w1qlo79j6tscii19jszwp9s2i55 notifications contain the following information:

[cols="1,4,1" options="header"]
|===

|Parameter Name
|Description
|Required by {branding} Standard UI

|application
|"Downloads" for resource retrieval.
This is used as a "type" or category of messages.
|Yes

|title
|Resource/file name for resource retrieval.
|Yes

|message
|Human-readable message containing status and a more detailed message.
|Yes

|timestamp
|Timestamp in milliseconds of when event occurs.
|Yes

|user
|CometD Session ID or unique User ID.
|Yes

|status
|Status of event.
|No

|option
|Resource retrieval option.
|No

|bytes
|Number of bytes transmitted.
|No

|===

====== Receive Notifications

* If interested in retrieve resource notifications, a client must subscribe to the CometD `channel/ddf/notification/catalog/downloads`.
* If interested in all notification types, a client must subscribe to the CometD `channel/ddf/notification/**`
* A client will only receive notifications for resources they have requested.
* {branding} Standard UI is subscribed to all notifications of interest to that `user/browser session: /ddf/notification/**`
* See the Usage section for the data that a notification contains.

====== Publish Notifications
Any application running in {branding} can publish notifications that can be viewed by the {branding} Standard UI or received by another notifications client.
. Set a properties map containing entries for each of the parameters listed above in the Usage section.
+
. Set the OSGi event topic to `ddf/notification/<application-name>/<notification-type>`.
Notice that there is no preceding slash on an OSGi event topic name, while there is one on the CometD channel name.
The OSGi event topic corresponds to the CometD channel this is published on.
+
. Post the notification to the OSGi event defined in the previous step.

.Example for Publishing Notification
[source,java,linenums]
----
Dictionary <String, Object> properties = new Hashtable<String, Object>();
properties.put("application", "Downloads");
properties.put("title", resourceResponse.getResource().getName());
Long sysTimeMillis = System.currentTimeMillis();
properties.put("message", generateMessage(status, resourceResponse.getResource().getName(), bytes, sysTimeMillis, detail));
properties.put("user", getProperty(resourceResponse, USER));
properties.put("status", "Completed");
properties.put("bytes", 1024);
properties.put("timestamp", sysTimeMillis);

Event event = new Event("ddf/notification/catalog/downloads", properties);

eventAdmin.postEvent(event);
----

===== Configuring Thread Pools

The `system.properties` file found under `$DDF_HOME/etc` contains properties that will be made available through system properties at the beginning of Karaf's boot process. The `org.codice.ddf.system.threadPoolSize` property can be used to specify the size of thread pools used by:
* Federating requests between {branding} systems
* Downloading resources
* Handling asynchronous queries, such as queries from the UI

By default, this value is set to 128. It is not recommended to set this value extremely high. If unsure, leave this setting at it's default value of 128.

==== Configuring Global System Properties
The `system.properties` file found under `$DDF_HOME/etc` contains properties that will be made available through the system properties on startup. After changing any of these properties you will need to restart the system. If you change the 'hostname' property you will also need to configure the certs as described in Configuring {branding} with New Certificates.
The system by default uses both http and https so both httpsPort and httpPort need to be specified. The protocol and port properties are the defaults the system should use in places where either http or https could be valid.
----
org.codice.ddf.system.protocol=https://        #one of http:// or https://
org.codice.ddf.system.hostname=localhost       #should be the fully qualified domain name
org.codice.ddf.system.httpsPort=8993           #secure port
org.codice.ddf.system.httpPort=8181            #public port
org.codice.ddf.system.port=8993                #default port corresponding to the protocol selected. Should match the httpPort or httpsPort
org.codice.ddf.system.rootContext=/services    #the root context that services will be made available under

org.codice.ddf.system.siteName=${sitename.default}        #the name of this instance
org.codice.ddf.system.siteContact=                        #contact for this instance
org.codice.ddf.system.version=${project.version}          #this instances version
org.codice.ddf.system.organization=${organization.name}   #who owns/runs this instance
----

The above properties (along with any other system properties) are available to be used as variable parameters in input url fields within the Admin Console. For example if you wanted to enter the url for the local csw service you could write
----
${org.codice.ddf.system.protocol}${org.codice.ddf.system.hostname}:${org.codice.ddf.system.port}${org.codice.ddf.system.rootContext}/csw
----

instead of

-----
https://localhost:8993/services/csw
-----

The variable version is longer but will not need to be changed if the system host, port or root context changes.

=== Managing Web Service Security

[IMPORTANT]
====
{branding} is enabled with an Insecure Defaults Service which will warn users/admins if the system is configured with insecure defaults.

A banner is displayed on the admin console notifying "The system is insecure because default configuration values are in use."

A detailed view is available of the properties to update.

====

===== Auditing

[NOTE]
====
The Audit Log default location is DISTRIBUTION_HOME/data/log/security.log
====

===== CAS Authentication

[NOTE]
====
CAS Authentication Logging was obtained using a CAS war file deployed to a Tomcat application server.
Tomcat allows configuration of the log file, but, by default, the logs below were stored in the $TOMCAT_HOME/logs/catalina.out file.
====

====== Username and Password
.Sample – Successful login
[source,bash]
----
2013-04-24 10:39:45,265 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <org.jasig.cas.adaptors.ldap.FastBindLdapAuthenticationHandler successfully authenticated [username: testuser1]>
2013-04-24 10:39:45,265 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <Resolved principal testuser1>
2013-04-24 10:39:45,265 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <org.jasig.cas.adaptors.ldap.FastBindLdapAuthenticationHandler@6a4d37e5 authenticated testuser1 with credential [username: testuser1].>
2013-04-24 10:39:45,265 INFO [com.github.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - <Audit trail record BEGIN
=============================================================
WHO: [username: testuser1]
WHAT: supplied credentials: [username: testuser1]
ACTION: AUTHENTICATION_SUCCESS
APPLICATION: CAS
WHEN: Wed Apr 24 10:39:45 MST 2013
CLIENT IP ADDRESS: 127.0.0.1
SERVER IP ADDRESS: 127.0.0.1
=============================================================
>
----

.Sample – Failed login
[source,bash]
----
2013-04-24 10:39:17,443 INFO [org.jasig.cas.adaptors.ldap.FastBindLdapAuthenticationHandler] - <Failed to authenticate user testuser1 with error [LDAP: error code 49 - Invalid Credentials]; nested exception is javax.naming.AuthenticationException: [LDAP: error code 49 - Invalid Credentials]>
2013-04-24 10:39:17,443 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <org.jasig.cas.adaptors.ldap.FastBindLdapAuthenticationHandler failed authenticating [username: testuser1]>
2013-04-24 10:39:17,443 INFO [com.github.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - <Audit trail record BEGIN
=============================================================
WHO: [username: testuser1]
WHAT: supplied credentials: [username: testuser1]
ACTION: AUTHENTICATION_FAILED
APPLICATION: CAS
WHEN: Wed Apr 24 10:39:17 MST 2013
CLIENT IP ADDRESS: 127.0.0.1
SERVER IP ADDRESS: 127.0.0.1
=============================================================
>
----

====== PKI Certificate

[NOTE]
====
Current testing was performed using the OZone certificates that came with a testAdmin and testUser, which were signed by a common CA.
====

.Sample – Successful login
[source,bash]
----
2013-04-24 15:13:14,388 INFO [org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler] - <Successfully authenticated CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US, SerialNumber=4>
2013-04-24 15:13:14,390 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler successfully authenticated CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US, SerialNumber=4>
2013-04-24 15:13:14,391 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <Resolved principal CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US>
2013-04-24 15:13:14,391 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler@1e5b04ae authenticated CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US with credential CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US, SerialNumber=4.>
2013-04-24 15:13:14,394 INFO [com.github.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - <Audit trail record BEGIN
=============================================================
WHO: CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US, SerialNumber=4
WHAT: supplied credentials: CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US, SerialNumber=4
ACTION: AUTHENTICATION_SUCCESS
APPLICATION: CAS
WHEN: Wed Apr 24 15:13:14 MST 2013
CLIENT IP ADDRESS: 127.0.0.1
SERVER IP ADDRESS: 127.0.0.1
=============================================================
>
----

.Sample – Failed login
[source,bash]
----
The failure was simulated using a filter on the x509 credential handler. This filter looks for a certain CN in the certificate chain and will fail if it cannot find a match. The server was set up to trust the certificate via the Java truststore, but there were additional requirements for logging in. For this test-case, the chain it was looking for is "CN=Hogwarts Certifying Authority.+". Example from the CAS wiki: https://wiki.jasig.org/display/CASUM/X.509+Certificates.
2013-04-25 14:15:47,477 DEBUG [org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler] - <Evaluating CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US, SerialNumber=4>
2013-04-25 14:15:47,478 DEBUG [org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler] - <.* matches CN=testUser1, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US == true>
2013-04-25 14:15:47,478 DEBUG [org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler] - <CN=Hogwarts Certifying Authority.+ matches EMAILADDRESS=goss-support@owfgoss.org, CN=localhost, OU=Ozone, O=Ozone, L=Columbia, ST=Maryland, C=US == false>
2013-04-25 14:15:47,478 DEBUG [org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler] - <Found valid client certificate>
2013-04-25 14:15:47,478 INFO [org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler] - <Failed to authenticate org.jasig.cas.adaptors.x509.authentication.principal.X509CertificateCredentials@1795f1cc>
2013-04-25 14:15:47,478 INFO [org.jasig.cas.authentication.AuthenticationManagerImpl] - <org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler failed to authenticate org.jasig.cas.adaptors.x509.authentication.principal.X509CertificateCredentials@1795f1cc>
2013-04-25 14:15:47,478 INFO [com.github.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - <Audit trail record BEGIN
=============================================================
WHO: org.jasig.cas.adaptors.x509.authentication.principal.X509CertificateCredentials@1795f1cc
WHAT: supplied credentials: org.jasig.cas.adaptors.x509.authentication.principal.X509CertificateCredentials@1795f1cc
ACTION: AUTHENTICATION_FAILED
APPLICATION: CAS
WHEN: Thu Apr 25 14:15:47 MST 2013
CLIENT IP ADDRESS: 127.0.0.1
SERVER IP ADDRESS: 127.0.0.1
=============================================================
>
----

===== STS Authentication

====== Username and Password

.Sample – Successful login
[source,bash]
----
[INFO ] 2014-07-17 14:40:23,340 | qtp1401560510-76 | securityLogger  |  Username [pparker] successfully logged in using LDAP authentication. Request IP: 127.0.0.1, Port: 52365
[INFO ] 2014-07-17 14:40:24,074 | qtp1401560510-76 | securityLogger  |  Security Token Service REQUEST
STATUS: SUCCESS
OPERATION: Issue
URL: https://server:8993/services/SecurityTokenService
WS_SEC_PRINCIPAL: 1.2.840.113549.1.9.1=#160d69346365406c6d636f2e636f6d,CN=client,OU=I4CE,O=Lockheed Martin,L=Goodyear,ST=Arizona,C=US
ONBEHALFOF_PRINCIPAL: pparker
TOKENTYPE: http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0
CLAIMS_SECONDARY: [http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname]
 Request IP: 127.0.0.1, Port: 52365
----

.Sample – Failed login
[source,bash]
----
[WARN ] 2014-07-17 14:42:43,627 | qtp1401560510-75 | securityLogger  |  Username [pparker] failed LDAP authentication. Request IP: 127.0.0.1, Port: 52386
[WARN ] 2014-07-17 14:42:43,632 | qtp1401560510-75 | securityLogger  |  Security Token Service REQUEST
STATUS: FAILURE
OPERATION: Issue
URL: https://server:8993/services/SecurityTokenService
WS_SEC_PRINCIPAL: 1.2.840.113549.1.9.1=#160d69346365406c6d636f2e636f6d,CN=client,OU=I4CE,O=Lockheed Martin,L=Goodyear,ST=Arizona,C=US
ONBEHALFOF_PRINCIPAL: pparker
TOKENTYPE: http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0
CLAIMS_SECONDARY: [http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname]
EXCEPTION: org.apache.cxf.ws.security.sts.provider.STSException: The specified request failed
 Request IP: 127.0.0.1, Port: 52386
----

====== PKI Certificate

.Sample – Successful login
[source,bash]
----
[INFO ] 2014-07-17 15:03:39,379 | qtp1401560510-74 | securityLogger  |  Security Token Service REQUEST
STATUS: SUCCESS
OPERATION: Issue
URL: https://localhost:8993/services/SecurityTokenService
WS_SEC_PRINCIPAL: 1.2.840.113549.1.9.1=#160d69346365406c6d636f2e636f6d,CN=client,OU=I4CE,O=Lockheed Martin,L=Goodyear,ST=Arizona,C=US
TOKENTYPE: http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0
CLAIMS_SECONDARY: [http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname, http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname]
 Request IP: 127.0.0.1, Port: 52573
----

.Sample – Failed login
[source,bash]
----
[WARN ] 2014-07-17 15:05:46,061 | qtp1401560510-75 | securityLogger  |  Security Token Service REQUEST
STATUS: FAILURE
OPERATION: Issue
URL: N.A.
TOKENTYPE: N.A.
APPLIESTO: <null>
EXCEPTION: org.apache.cxf.ws.security.sts.provider.STSException: The request was invalid or malformed
 Request IP: 127.0.0.1, Port: 52582
----

====== Binary Security Token (CAS)

.Sample – Successful Login
[source,bash]
----
15:27:48,098 | INFO  | tp1343209378-282 | securityLogger                   | rity.common.audit.SecurityLogger  156 | 247 - security-core-api - 2.2.0.RC6-SNAPSHOT | Telling the STS to request a security token on behalf of the binary security token:
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<BinarySecurityToken ValueType="#CAS" EncodingType="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary" ns1:Id="CAS" xmlns="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" xmlns:ns1="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd">U1QtMTctQmw0aGRrS05jaTV3cE82Zm11VE0tY2FzfGh0dHBzOi8vdG9rZW5pc3N1ZXI6ODk5My9zZXJ2aWNlcy9TZWN1cml0eVRva2VuU2VydmljZQ==</BinarySecurityToken>
 Request IP: 0:0:0:0:0:0:0:1%0, Port: 53363
15:27:48,351 | INFO  | tp1343209378-282 | securityLogger                   | rity.common.audit.SecurityLogger  156 | 247 - security-core-api - 2.2.0.RC6-SNAPSHOT | Finished requesting security token. Request IP: 127.0.0.1, Port: 53363

**This message will show when DEBUG is on**
15:27:48,355 | DEBUG | tp1343209378-282 | securityLogger                   | rity.common.audit.SecurityLogger  102 | 247 - security-core-api - 2.2.0.RC6-SNAPSHOT | <?xml version="1.0" encoding="UTF-16"?>
<saml2:Assertion>
SAML ASSERTION WILL BE LOCATED HERE
----

.Sample – Failed Login
[source,bash]
----
10:54:21,772 | INFO  | qtp995500086-618 | securityLogger                   | rity.common.audit.SecurityLogger  143 | 245 - security-core-commons - 2.2.0.ALPHA5-SNAPSHOT | Telling the STS to request a security token on behalf of the binary security token:
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<BinarySecurityToken ValueType="#CAS" EncodingType="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary" ns1:Id="CAS" xmlns="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" xmlns:ns1="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd">U1QtMjctOU43RUlkNHkzVFoxQmZCb0RIdkItY2Fz</BinarySecurityToken>
10:54:22,119 | INFO  | qtp995500086-141 | securityLogger                   | rity.common.audit.SecurityLogger  143 | 245 - security-core-commons - 2.2.0.ALPHA5-SNAPSHOT | Validating ticket [ST-27-9N7EId4y3TZ1BfBoDHvB-cas] for service [https://server:8993/services/SecurityTokenService]. Request IP: 127.0.0.1, Port: 64548
10:54:22,169 | INFO  | qtp995500086-141 | securityLogger                   | rity.common.audit.SecurityLogger  143 | 245 - security-core-commons - 2.2.0.ALPHA5-SNAPSHOT | Unable to validate CAS token. Request IP: 127.0.0.1, Port: 64548
10:54:22,244 | INFO  | qtp995500086-618 | securityLogger                   | rity.common.audit.SecurityLogger  143 | 245 - security-core-commons - 2.2.0.ALPHA5-SNAPSHOT | Error requesting the security token from STS at: https://server:8993/services/SecurityTokenService.
----

===== AuditPlugin

{branding} provides an optional *Audit Plugin* that logs all catalog transactions to the `security.log`.
Information captured includes user identity, query information, and resources retrieved.

====== Configuring Audit Plugin
The Audit plugin is not enabled by default. To enable, sign into the Admin Console............................................................................

. Select {branding} Catalog
. Select _Features_ tab
. Install both `catalog-security-logging` and `catalog-security-audit-plugin` features............................................................................

==== Web Context Policy Manager

The Web Context Policy Manager defines all security policies for REST endpoints within {branding}.
It defines :

* the realms a context should authenticate against.
* the type of authentication that a context requires.
* any user attributes required for authorization.

===== Configuring Web Context Policy Manager

The karaf realm is the only realm available by default and it authenticates against the user.properties file. As JAAS authentication realms are added to the STS, more realms become available to authenticate against.

For example, installing the `security-sts-ldaplogin` feature adds an ldap realm. Contexts can then be pointed to ldap realm for authentication and STS will be instructed to authenticate them against ldap. As you add REST endpoints, you may need to add different types of authentication through the Web Context Policy Manager.

.Default Types of Authentication
[cols="1,4" options="header"]
|===

|saml
|Activates single-sign on (SSO) across all REST endpoints that use.

|basic
|Activates basic authentication.

|PKI
|Activates public key infrastructure authentication

|guest
|provides guest access

|===

==== CAS SSO Configuration

The Web Service Security (WSS) Implementation that comes with {branding} was built to run independent of an SSO or authentication mechanism. Testing out the security functionality of {branding} was performed by using the Central Authentication Server (CAS) software. This is a popular SSO appliance and allowed {branding} to be tested using realistic use cases. This page contains configurations and settings that were used to help enable CAS to work within the {branding} environment.

===== General Server Setup and Configuration

[NOTE]
====
The following procedure defines the steps for installing CAS to a Tomcat 7.x server running in Linux and Windows. Newer versions of tomcat (8.x) are incompatible with the included server.xml file and will need additional changes.
====

====== Install using {branding} CAS WAR
{branding} comes with a custom distribution of the CAS Web application that comes with LDAP and X.509 support configured and built-in. Using this configuration may save time and make setup easier.

[NOTE]
====
The CAS Web Application can be downloaded from Nexus. To find the latest version, execute a search for "cas-distribution". Link to the first release: http://artifacts.codice.org/content/repositories/releases/org/codice/cas/distribution/cas-distribution/1.0.0/cas-distribution-1.0.0.war
====

. Download and unzip Tomcat Distribution [http://tomcat.apache.org/download-70.cgi].  The installation location is referred to as `<TOMCAT_INSTALLATION_DIR>`.
+
----
$ unzip apache-tomcat-7.0.39.zip
----
+
. Clone https://github.com/codice/cas-distribution to a convenient location.  This folder will be referred to as cas-distribution.
. Set up Keystores and enable SSL. There are sample configurations located within the security-cas-server-webapp project.
.. Copy setenv (cas-distribution/src/main/resources/tomcat) to TOMCAT/bin
+
.Linux
----
$ cp cas-distribution/src/main/resources/tomcat/setenv.sh <TOMCAT_INSTALLATION_DIR>/bin/
----
+
.Windows
----
copy cas-distribution\src\main\resources\tomcat\setenv.bat <TOMCAT_INSTALLATION_DIR>\bin\
----
+
.. Copy server.xml (`cas-distribution/src/main/resources/tomcat/conf`) to `<TOMCAT_INSTALLATION_DIR>/conf`
+
.Linux
----
$ cp cas-distribution/src/main/resources/tomcat/conf/server.xml <TOMCAT_INSTALLATION_DIR>/conf/
----
+
.Windows
----
$ cp cas-distribution/src/main/resources/tomcat/conf/server.xml <TOMCAT_INSTALLATION_DIR>/conf/
----
+
.. The above files point to `<TOMCAT_INSTALLATION_DIR>/certs/keystore.jks` as the default keystore location to use. This file does not come with Tomcat and needs to be created or the files copied above (setenv.sh and server.xml) need to be modified to point to the correct keystore.
+
----
mkdir <TOMCAT_INSTALLATION_DIR>/certs
----
+
Copy casKeystore.jks from the {branding} installation directory into <TOMCAT_INSTALLATION_DIR>/certs/.  This will allow CAS to use a "cas" private key and to trust anything signed by "server", "ca", or "ca-root".
Linux  Expand source
Windows  Expand source
+
. Start Tomcat.
+
----
$ cd <TOMCAT_INSTALLATION_DIR>/bin/
$ ./startup.sh
----
+
[WARNING]
====
Make sure to run startup.bat instead of startup.sh if Windows is running on a Window machine. If setenv.sh was not converted to a .bat above, startup.bat will not function correctly.
====
+
If the Tomcat log has can exception like the following, or if you cannot access cas via port 8443 after completing the steps below:
+
----
SEVERE: Failed to initialize end point associated with ProtocolHandler ["http-apr-8443"]
java.lang.Exception: Connector attribute SSLCertificateFile must be defined when using SSL with APR
----
+
uncomment the following in server.xml:
+
[source,xml,linenums]
----
<Listener className="org.apache.catalina.security.SecurityListener" />
----
+
then comment out:
+
[source,xml,linenums]
----
<Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" />
----
+
. Deploy the {branding} CAS WAR to Tomcat.
+
.. Obtain the CAS WAR by building it from cas-distribution.
.. Copy it into the webapps folder on Tomcat:
+
----
$ cp cas-distribution/target/cas.war <TOMCAT_INSTALLATION_DIR>/webapps/
----

CAS should now be running on the Tomcat server. To verify it started without issues, check the Tomcat log and look for lines similar to the following:
----
Apr 25, 2013 10:55:39 AM org.apache.catalina.startup.HostConfig deployWAR
INFO: Deploying web application archive /apache-tomcat-7.0.39/webapps/cas.war
2013-04-25 10:55:42,831 INFO [org.jasig.cas.services.DefaultServicesManagerImpl] - <Loaded 1 services.>
2013-04-25 10:55:43,540 INFO [org.jasig.cas.util.AutowiringSchedulerFactoryBean] - <Starting Quartz Scheduler now>
----
CAS will try to authenticate first with X.509 (using the keystore provided as the truststore) and failover to LDAP username/password.
The {branding} distribution of CAS is configured to use the embedded {branding} instance running on localhost. Configuring the LDAP location may be performed by modifying the bottom of the `cas.properties` file located in `TOMCAT/webapps/cas/WEB-INF/` after the web application is deployed.

====== Configure an Existing CAS Installation
If upgrading an existing CAS installation or using the standard CAS web application, refer to the Configure CAS for LDAP page or the Configure CAS for X509 User Certificates page for directions on specific configurations that need to be performed.

[WARNING]
====
As part of setting up the server, it is critical to make sure that Tomcat trusts the {branding} server certificate and that {branding} trusts the certificate from Tomcat. If this is not done correctly, CAS and/or {branding} will throw certificate warnings in their logs and will not allow access.
====

===== Configure CAS for {branding}
When configuring CAS to integrate with {branding}, there are two main configurations that need to be modified. By default, {branding} uses 'server' as the hostname for the local {branding} instance and 'cas' as the hostname for the CAS server.

====== CAS Client
The CAS client bundle contains CAS client code that can be used by other bundles when validating and retrieving tickets from CAS. This bundle is extensively used when performing authentication.

When setting up {branding}, the 'Server Name' and 'Proxy Callback URL' must be set to the hostname of the local {branding} instance.

The 'CAS Server URL' configuration should point to the hostname of the CAS server and should match the SSL certificate that it is using.

====== CAS Token Validator
The 'CAS Server URL' configuration should point to the hostname of the CAS server and should match the SSL certificate that it is using.

====== Additional Configuration
Information on each of the CAS-specific bundles that come with {branding}, as well as their configurations, can be found on the Security CAS application page.

===== Example Workflow
The following is a sample workflow hat shows how CAS integrates within the {branding} WSS Implementation.

. User points browser to {branding} Query Page.
. CAS servlet filters are invoked during request.
. Assuming a user is not already signed in, the user is redirected to CAS login page.
.. For X.509 authentication, CAS will try to obtain a certificate from the browser. Most browsers will prompt the user to select a valid certificate to use.
.. For username/password authentication, CAS will display a login page.
. After successful sign-in, the user is redirected back to {branding} Query page.
. {branding} Query Page obtains the Service Ticket sent from CAS, gets a Proxy Granting Ticket (PGT), and uses that to create a Proxy Ticket for the STS.
. The user fills in search phrase and selects *Search*.
. The Security API uses the incoming CAS proxy ticket to create a RequestSecurityToken call to the STS.
. The STS validates the proxy ticket to CAS and creates SAML assertion.
. The Security API returns a Subject class that contains the SAML assertion.
. The Query Page creates a new QueryRequest and adds the Subject into the properties map.

From step 10 forward, the message is completely decoupled from CAS and will proceed through the framework properly using the SAML assertion that was created in step 8.

==== Configuring CAS for LDAP

===== Install and Configure LDAP
{branding} comes with an embedded LDAP instance that can be used for testing. During internal testing this LDAP was used extensively.

More information on configuring the LDAP and a list of users and attributes can be found at the Embedded LDAP Configuration page.

===== Add cas-server-support-ldap-3.3.1_1.jar to CAS
Copy `thirdparty/cas-server-support-ldap-3.3.1/target/cas-server-support-x509-3.3.1_1.jar` to `{ozone-widget-framework}/apache-tomecat-{version}/webapps/cas/WEB-INF/lib/cas-server-support-ldap-3.3.1_1.jar`.

===== Add spring-ldap-1.2.1_1.jar to CAS
Copy `thirdparty/spring-ldap-1.2.1/target/spring-ldap-1.2.1_1.jar` to `{ozone-widget-framework}/apache-tomecat-{version}/webapps/cas/WEB-INF/lib/spring-ldap-1.2.1_1.jar`.

===== Modify developerConfigContext.xml
. In `{ozone-widget-framework}/apache-tomecat-{version}/webapps/cas/WEB-INF/deployerConfigContext.xml`, add the `FastBindLdapAuthenticationHandler` bean definition to the `<list>` in the property stanza with name `authenticationHandlers` of the bean stanza with id `authenticationManager`:
+
.deployerConfigContext.xml
[source,xml,linenums]
----
<bean id="authenticationManager" class="org.jasig.cas.authentication.AuthenticationManagerImpl">

    <!-- other property definitions -->

    <property name="authenticationHandlers">
        <list>
            <bean class="org.jasig.cas.adaptors.ldap.FastBindLdapAuthenticationHandler" >
                <property name="filter" value="uid=%u,ou=users,dc=example,dc=com" />
                <property name="contextSource" ref="contextSource" />
            </bean>

            <!-- other bean definitions -->

        </list>
    </property>
</bean>
----
+
. In `{ozone-widget-framework}/apache-tomecat-{version}/webapps/cas/WEB-INF/deployerConfigContext.xml`, remove the bean stanza with class `ozone3.cas.adaptors.UserPropertiesFileAuthenticationHandler` from the `<list>` of the property stanza with name `authenticationHandlers`.
. In `{ozone-widget-framework}/apache-tomecat-{version}/webapps/cas/WEB-INF/deployerConfigContext.xml`, add the contextSource bean stanza to the beans stanza:
+
.deployerConfigContext.xml
[source,xml,linenums]
----
<bean id="contextSource" class="org.jasig.cas.adaptors.ldap.util.AuthenticatedLdapContextSource">
    <property name="urls">
        <list>
            <value>ldap://localhost:1389</value>
        </list>
    </property>
    <property name="userDn" value="uid=admin,ou=system"/>
    <property name="password" value="secret"/>
</bean>
----

===== Configure Ozone

Ozone is also set up to work in LDAP. This section is a reference when Ozone is being used in conjunction with CAS. The following settings were used for internal testing and should only be used as a reference.

. Modify OWFsecurityContext.xml
.. In {ozone-widget-framework}/apache-tomecat-{version}/lib/OWFsecurityContext.xml, change the sec:x509 stanza to the following:
+
.OWFsecurityContext.xml
[source]
----
<sec:x509 subject-principal-regex="CN=(.*?)," user-service-ref="ldapUserService" />
----
+
.. In {ozone-widget-framework}/apache-tomecat-{version}/lib/OWFsecurityContext.xml, remove the following import:
+
.OWFsecurityContext.xml
[source]
----
<import resource="ozone-security-beans/UserServiceBeans.xml" />
----
+
.. In `{ozone-widget-framework}/apache-tomecat-{version}/lib/OWFsecurityContext.xml`, add the following import:
+
.OWFsecurityContext.xml
[source]
----
<import resource="ozone-security-beans/LdapBeans.xml" />
----
+
. Modify LdapBeans.xml
.. In {ozone-widget-framework}/apache-tomecat-{version}/lib/ozone-security-beans/LdapBeans.xml, change the bean stanza with id `contextSource` to the following:
+
.LdapBeans.xml
[source,xml,linenums]
----
<bean id="contextSource" class="org.springframework.security.ldap.DefaultSpringSecurityContextSource">
    <!-- The URL of the ldap server, along with the base path that all other ldap path will be relative to -->
    <constructor-arg value="ldap://localhost:1389/dc=example,dc=com"/>
</bean>
----
+
.. In {ozone-widget-framework}/apache-tomecat-{version}/lib/ozone-security-beans/LdapBeans.xml, change the bean stanza with id `authoritiesPopulator` to the following:
+
.LdapBeans.xml
[source,xml,linenums]
----
<bean id="authoritiesPopulator" class="org.springframework.security.ldap.userdetails.DefaultLdapAuthoritiesPopulator">
    <constructor-arg ref="contextSource"/>
    <!-- search base for determining what roles a user has -->
    <constructor-arg value="ou=roles"/>
</bean>
----
+
.. In {ozone-widget-framework}/apache-tomecat-{version}/lib/ozone-security-beans/LdapBeans.xml, change the bean stanza with id `ldapUserSearch` to the following:
+
.LdapBeans.xml
[source,xml,linenums]
----
<bean id="ldapUserSearch" class="org.springframework.security.ldap.search.FilterBasedLdapUserSearch">
    <!-- search base for finding User records -->
    <constructor-arg value="ou=users" />
    <constructor-arg value="(uid={0})" /> <!-- filter applied to entities under the search base in order to find a given user.
                                                this default searches for an entity with a matching uid -->
    <constructor-arg ref="contextSource" />
</bean>
----
.. In {ozone-widget-framework}/apache-tomecat-{version}/lib/ozone-security-beans/LdapBeans.xml, change the bean stanza with id `userDetailsMapper` to the following:
+
.LdapBeans.xml
[source,xml,linenums]
----
<bean id="userDetailsMapper" class="ozone.securitysample.authentication.ldap.OWFUserDetailsContextMapper">
    <constructor-arg ref="contextSource" />
    <!-- search base for finding OWF group membership -->
    <constructor-arg value="ou=groups" />
    <constructor-arg value="(member={0})" /> <!-- filter that matches only groups that have the given username listed
                                                      as a "member" attribute -->
</bean>
----
+
. Modify OWFCASBeans.xml
.. In {ozone-widget-framework}/apache-tomecat-{version}/lib/ozone-security-beans/OWFCasBeans.xml, change the bean stanza with id `casAuthenticationProvider` to the following:
+
.OWFCasBeans.xml
[source,xml,linenums]
----
<bean id="casAuthenticationProvider" class="org.springframework.security.cas.authentication.CasAuthenticationProvider">
    <property name="userDetailsService" ref="ldapUserService" />
    <property name="serviceProperties" ref="serviceProperties" />
    <property name="ticketValidator" ref="ticketValidator" />
    <property name="key" value="an_id_for_this_auth_provider_only" />
</bean>
----

==== Configuring CAS for X509 User Certificates

The follow settings were tested with CAS version 3.3.1. If any issues occur while configuring for newer versions, check the External Links section at the bottom of this page for the CAS documentation, which explains setting up certification authentication.

===== Add the cas-server-support-x509-3.3.1.jar to CAS
Copy `thirdparty/cas-server-support-x509-3.3.1/target/cas-server-support-x509-3.3.1.jar` to `apache-tomecat-{version}/webapps/cas/WEB-INF/lib/cas-server-support-x509-3.3.1.jar`.

===== Configure Web Flow

. In apache-tomcat-{version}/webapps/cas/WEB-INF/login-workflow.xml, make the following modifications:
.. Remove the XML comments around the action-state stanza with id `startAuthenticate`.
+
.startAuthenticate
[source,xml,linenums]
----
<action-state id="startAuthenticate">
  <action bean="x509Check" />
  <transition on="success" to="sendTicketGrantingTicket" />
  <transition on="error" to="viewLoginForm" />
</action-state>
----
+
.. Modify the decision-state stanza with id `renewRequestCheck` as follows.
+
.renewRequestCheck
[source,xml,linenums]
----
<decision-state id="renewRequestCheck">
  <if test="{externalContext.requestParameterMap['renew'] != '' &amp;&amp; externalContext.requestParameterMap['renew'] != null}" then="startAuthenticate" else="generateServiceTicket" />
</decision-state>
----
+
.. Modify the decision-state stanza with id `gatewayRequestCheck` as follows.
+
.gatewayRequestCheck
[source,xml,linenums]
----
<decision-state id="gatewayRequestCheck">
  <if test="{externalContext.requestParameterMap['gateway'] != '' &amp;&amp; externalContext.requestParameterMap['gateway'] != null &amp;&amp; flowScope.service != null}" then="redirect" else="startAuthenticate" />
</decision-state>
----
+
. In `apache-tomcat-{version}/webapps/cas/WEB-INF/cas-servlet.xml` make the following modifications:
.. Define the x509Check bean.
+
.x509Check
[source,xml,linenums]
----
<bean
   id="x509Check"
   p:centralAuthenticationService-ref="centralAuthenticationService"
   class="org.jasig.cas.adaptors.x509.web.flow.X509CertificateCredentialsNonInteractiveAction" >
   <property name="centralAuthenticationService" ref="centralAuthenticationService"/>
</bean>
----

===== Configure the Authentication Handler
In `apache-tomcat-{version}/webapps/cas/WEB-INF/deployerConfigContext.xml`, make the following modifications:

. In the *`list`* stanza of the property stanza with name `authenticationHandlers` of the bean stanza with id `authenticationManager`, add the `X509CredentialAuthenticationHander` bean definition.
+
.X509CredentialAuthenticationHander
[source,xml,linenums]
----
<bean id="authenticationManager"
  class="org.jasig.cas.authentication.AuthenticationManagerImpl">

  <!-- Other property definitions -->

   <property name="authenticationHandlers">
     <list>

       <!-- Other bean definitions -->

       <bean
         class="org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler">
         <property name="trustedIssuerDnPattern" value=".*" />
         <!--
           <property name="maxPathLength" value="3" />
           <property name="checkKeyUsage" value="true" />
           <property name="requireKeyUsage" value="true" />
         -->
       </bean>
    </list>
  </property>
</bean>
----

===== Configure the Credentials to the Principal Resolver
In `apache-tomcat-{version}/webapps/cas/WEB-INF/deployerConfigContext.xml`, make the following modifications:

. In the list stanza of the property stanza with name `credentialsToPrincipalResolver` of the bean stanza with id `AuthenticationManager`, add the `X509CertificateCredentialsToIdentifierPrincipalResolver` bean definition.  The pattern in the value attribute on the property stanza can be modified to suit your needs.  The following is a simple example that uses the first CN field in the DN as the Principal.
+
.X509CertificateCredentialsToIdentifierPrincipalResolver
[source,xml,linenums]
----
<bean id="authenticationManager"
  class="org.jasig.cas.authentication.AuthenticationManagerImpl">
  <property name="credentialsToPrincipalResolvers">
    <list>

      <!-- Other bean definitions -->

      <bean
        class="org.jasig.cas.adaptors.x509.authentication.principal.X509CertificateCredentialsToIdentifierPrincipalResolver">
        <property name="identifier" value="$OU $CN" />
      </bean>
    </list>
  </property>
  <!-- Other property definitions -->

</bean>
----
+
. In addition to the PrincipalResolver mentioned above, CAS comes with other resolvers that can return different representations of the user identifier. This list was obtained from the official CAS Documentation site linked at the bottom of this page.
+
[cols="2" options="header"]
|===

|Resolver Class
|Identifier Output

|X509CertificateCredentialsToDistinguishedNamePrincipalResolver
|Retrieve the complete distinguished name and use that as the identifier.

|X509CertificateCredentialsToIdentifierPrincipalResolver
|Transform some subset of the identifier into the ID for the principal.

|X509CertificateCredentialsToSerialNumberPrincipalResolver
|Use the unique serial number of the certificate.

|X509CertificateCredentialsToSerialNumberAndIssuerDNPrincipalResolver
|Create a most-likely globally unique reference to this certificate as a DN-like entry, using the CA name and the unique serial number of the certificate for that CA.
|===

Different resolvers should be used depending on the use-case for the server. When performance external attribute lookup (e.g., attribute lookup via DIAS) it is necessary to have CAS return the full DN as the identifier and the class X509CertificateCredentialsToDistinguishedNamePrincipalResolver should be used. When using a local LDAP, however, the X509CertificateCredentialsToIdentifierPrincipalResolver class can be used to only return the username that maps directly to the LDAP username.

===== Default Certificates
To verify certificate authentication with the default CAS files you must make sure that the included testUser and testAdmin certificates are installed into your web browser. This has only been tested to work with Firefox. These certificates were provided in the Ozone Widget Framework and can be used in development environments.

* The sample certificate for testUser1 is {ozone-widget-framework}/apache-tomcat-{version}/certs/testUser1.p12
** password: password
* The sample certificate for testAdmin1 is {ozone-widget-framework}/apache-tomcat-{version}/certs/testAdmin1.p12
** password: password

===== External Links
For more information on CAS configuration options and what each setting means, refer to their documentation page: https://wiki.jasig.org/display/CASUM/X.509+Certificates.

==== Certificate Management
{branding} uses certificates in two ways:

. To transmit and receive encrypted messages.
. To perform authentication of an incoming user request.
This page details general management operations of using certificates in {branding}.

===== Default Certificates
{branding} comes with a default keystore that contains certificates. The keystore is used for different services and the certificate contained within it is aliased to "localhost".
[cols="5" options="header"]
|===

|Host
|Keystore
|Truststore
|Configuration Location
|Usage

|localhost
|serverKeystore.jks
|serverTruststore.jks
|File: etc/system.properties

File: etc/ws-security/server/encryption.properties

File: etc/ws-security/server/signature.properties

File: etc/ws-security/issuer/encryption.properties

File: etc/ws-security/issuer/signature.properties

File: etc/system.properties
|Used to secure (SSL) all of the endpoints for {branding}, to perform outgoing SSL requests, sign STS SAML assertions. This also includes the admin console and any other web service that is hosted by {branding}.

|===

===== File Management
File management includes creating and configuring the files that contain the certificates. In {branding}, these files are generally Java Keystores (jks) and Certificate Revocation Lists (crl). This includes commands and tools that can be used to perform these operations.

The following tools are used:

* openssl
** Windows users can use: openssl for windows (https://code.google.com/p/openssl-for-windows/downloads/detail?name=openssl-0.9.8k_X64.zip&can=2&q=)
* The standard Java *keytool* certificate management utility (http://docs.oracle.com/javase/7/docs/technotes/tools/windows/keytool.html)
Portecle (http://portecle.sourceforge.net/) can be used for *keytool* operations if a GUI if preferred over a command line interface

====== General Certificates

====== Create a CA Key and Certificate
The following steps define the procedure for creating a root CA to sign certificates.

. Create a key pair. +
 `$> openssl genrsa -aes128 -out root-ca.key 1024`
. Use the key to sign the CA certificate. +
`$> openssl req -new -x509 -days 3650 -key root-ca.key -out root-ca.crt`

====== Use the CA to Sign Certificates
The following steps define the procedure for signing a certificate for the tokenissuer user by a CA.

.  Generate a private key and a Certificate Signing Request (CSR). +
`$> openssl req -newkey rsa:1024 -keyout tokenissuer.key -out tokenissuer.req`
.  Sign the certificate by the CA. +
`$> openssl ca -out tokenissuer.crt -infiles tokenissuer.req`

====== Java Keystore (JKS)

====== Create a New Keystore/Truststore with an Existing Certificate and Private Key
.  Using the private key, certificate, and CA certificate, create a new keystore containing the data from the new files.
+
[source]
----
cat client.crt >> client.key
openssl pkcs12 -export -in client.key -out client.p12
keytool -importkeystore -srckeystore client.p12 -destkeystore serverKeystore.jks -srcstoretype pkcs12 -alias 1
keytool -changealias -alias 1 -destalias client -keystore serverKeystore.jks
keytool -importcert -file ca.crt -keystore serverKeystore.jks -alias "ca"
keytool -importcert -file ca-root.crt -keystore serverKeystore.jks -alias "ca-root"
----
+
.  Create the truststore using just the CA certificate. Based on the concept of CA signing, the CA should be the only entry needed in the truststore.
+
----
keytool -import -trustcacerts -alias "ca" -file ca.crt -keystore truststore.jks
keytool -import -trustcacerts -alias "ca-root" -file ca-root.crt -keystore truststore.jks
----
+
. Create a PEM file using the certificate, as it is the format that some applications use.
+
----
openssl x509 -in client.crt -out client.der -outform DER
openssl x509 -in client.der -inform DER -out client.pem -outform PEM
----

====== Import into a Java Keystore (JKS)

The following steps define the procedure for importing a PKCS12 keystore generated by openssl into a Java keystore (JKS).

.  Put the private key and the certificate into one file. +
`$> cat tokenissuer.crt >> tokenissuer.key`
.  Put the private key and the certificate in a PKCS12 keystore. +
`$> openssl pkcs12 -export -in tokenissuer.key -out tokenissuer.p12`
.  Import the PKCS12 keystore into a JKS. +
`$> keytool -importkeystore -srckeystore tokenissuer.p12 -destkeystore stsKeystore.jks -srcstoretype pkcs12 -alias 1`
.  Change the alias. +
`$> keytool -changealias -alias 1 -destalias tokenissuer`

====== Certificate Revocation List (CRL)

====== Create a Certificate Revocation List (CRL)

.  Using the CA create in the above steps, create a CRL in which the tokenissuer's certificate is valid. +
`$> openssl ca -gencrl -out crl-tokenissuer-valid.pem`

====== Revoke a Certificate and Create a New CRL that Contains the Revoked Certificate
----
$> openssl ca -revoke tokenissuer.crt

$> openssl ca -gencrl -out crl-tokenissuer-revoked.pem
----

====== View a CRL

. Use the following command to view the serial numbers of the revoked certificates:
`$> openssl crl -inform PEM -text -noout -in crl-tokenissuer-revoked.pem`

===== Configuration Management
Configuration management includes configuring {branding} to use existing certificates and defining configuration options for the system. This includes configuration certificate revocation and keystores.

====== Certificate Revocation Configuration

====== Enable Revocation

[NOTE]
====
Enabling CRL revocation or modifying the CRL file will require a restart of {BRANDING} to apply updates.
====

. Place the CRL in `<ddf.home>/etc/keystores`.
. Uncomment or add the following line in `<ddf.home>/etc/ws-security/server/encryption.properties`, `<ddf.home>/etc/ws-security/issuer/encryption.properties`, `<ddf.home>/etc/ws-security/server/signature.properties`, and `<ddf.home>/etc/ws-security/issuer/signature.properties`  and replace the file name with the CRL file used in step 1. +
`#org.apache.ws.security.crypto.merlin.x509crl.file=etc/keystores/crl.pem`

Uncommenting this property will also enable CRL revocation for any context policy implementing PKI authentication. For example, adding an authentication policy in the Web Context Policy Manager of "/search=PKI|GUEST" will disable basic authentication, and require a certificate for the search UI. If a certificate is not in the CRL, it will be allowed through, otherwise it will get a 401 error. Not providing a cert will pass it to the guest handler and the user will be granted guest access.

This also enables CRL revocation for the STS endpoint. The STS CRL Interceptor monitors the same encryption.properties file and operates in an identical manner to how the PKI Authenication's CRL handler is set up. Enabling the CRL via the encryption.properties file will also enable it for the STS, and also requires a restart.

====== Disable Revocation

[NOTE]
====
Disabling CRL revocation or modifying the CRL file will require a restart of {BRANDING} to apply updates.
====

. Comment out or remove the following line in `<ddf.home>/etc/ws-security/server/encryption.properties`, `<ddf.home>/etc/ws-security/issuer/encryption.properties`, `<ddf.home>/etc/ws-security/server/signature.properties`, and `<ddf.home>/etc/ws-security/issuer/signature.properties`. +
`#org.apache.ws.security.crypto.merlin.x509crl.file=etc/keystores/crl.pem`

The PKIHandler will not check the CRL if this property is not defined. This will also disable the CRL interceptor for the STS endpoint.

====== Add Revocation to a Web Context
The PKIHandler implements CRL revocation, so any web context that is configured to use PKI authentication will also use CRL revocation if revocation is enabled.

. After enabling revocation (see above), open the Web Context Policy manager.
. Add or modify a Web Context to use PKI in authentication. For example, enabling CRL for the search ui endpoint would require adding an authorization policy of `/search=SAML|PKI`
. If guest access is required, add "GUEST" to the policy. Ex, `/search=SAML|PKI|GUEST`.

With guest access, a user with a revoked cert will be given a 401 error, but users without a certificate will be able to access the web context as the guest user.

The STS CRL interceptor does not need a web context specified. The CRL interceptor for the STS will become active after specifying the CRL file in the encryption.properties file and restarting {BRANDING}.

[NOTE]
====
Disabling or enabling CRL revocation or modifying the CRL file will require a restart of {BRANDING} to apply updates.
If CRL checking is already enabled, adding a new context via the Web Context Policy Manager will not require a restart.
====

====== Add Revocation to a New Endpoint

[NOTE]
====
This section explains how to add CXF's CRL revocation method to an endpoint and not the CRL revocation method in the PKIHandler described above.
====

This guide assumes that the endpoint being created uses CXF and is being started via Blueprint from inside the OSGi container.
If other tools are being used, the configuration may differ.
http://cxf.apache.org/docs/ws-securitypolicy.html[The CXF WS-Security page] contains additional information and samples.

. Add the following property to the jaxws endpoint in the endpoint's blueprint.xml: +
`<entry key="ws-security.enableRevocation" value="true"/>`
+
Example xml snippet for the jaxws:endpoint with the property:
[source,xml,linenums]
----
<jaxws:endpoint id="Test" implementor="#testImpl"
                wsdlLocation="classpath:META-INF/wsdl/TestService.wsdl"
                address="/TestService">

    <jaxws:properties>
        <entry key="ws-security.enableRevocation" value="true"/>
    </jaxws:properties>
</jaxws:endpoint>
----

====== Verify Revocation Is Taking Place

A warning similar to the following will be displayed in the logs of the source and endpoint showing the exception encountered during certificate validation:
----
11:48:00,016 | WARN  | tp2085517656-302 | WSS4JInInterceptor               | ecurity.wss4j.WSS4JInInterceptor  330 | 164 - org.apache.cxf.cxf-rt-ws-security - 2.7.3 |
org.apache.ws.security.WSSecurityException: General security error (Error during certificate path validation: Certificate has been revoked, reason: unspecified)
    at org.apache.ws.security.components.crypto.Merlin.verifyTrust(Merlin.java:838)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.ws.security.validate.SignatureTrustValidator.verifyTrustInCert(SignatureTrustValidator.java:213)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.ws.security.validate.SignatureTrustValidator.validate(SignatureTrustValidator.java:72)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.ws.security.validate.SamlAssertionValidator.verifySignedAssertion(SamlAssertionValidator.java:121)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.ws.security.validate.SamlAssertionValidator.validate(SamlAssertionValidator.java:100)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.ws.security.processor.SAMLTokenProcessor.handleSAMLToken(SAMLTokenProcessor.java:188)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.ws.security.processor.SAMLTokenProcessor.handleToken(SAMLTokenProcessor.java:78)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.ws.security.WSSecurityEngine.processSecurityHeader(WSSecurityEngine.java:396)[161:org.apache.ws.security.wss4j:1.6.9]
    at org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor.handleMessage(WSS4JInInterceptor.java:274)[164:org.apache.cxf.cxf-rt-ws-security:2.7.3]
    at org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor.handleMessage(WSS4JInInterceptor.java:93)[164:org.apache.cxf.cxf-rt-ws-security:2.7.3]
    at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:271)[123:org.apache.cxf.cxf-api:2.7.3]
    at org.apache.cxf.transport.ChainInitiationObserver.onMessage(ChainInitiationObserver.java:121)[123:org.apache.cxf.cxf-api:2.7.3]
    at org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:239)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at org.apache.cxf.transport.servlet.ServletController.invokeDestination(ServletController.java:218)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:198)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:137)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at org.apache.cxf.transport.servlet.CXFNonSpringServlet.invoke(CXFNonSpringServlet.java:158)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at org.apache.cxf.transport.servlet.AbstractHTTPServlet.handleRequest(AbstractHTTPServlet.java:243)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at org.apache.cxf.transport.servlet.AbstractHTTPServlet.doPost(AbstractHTTPServlet.java:163)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:713)[52:org.apache.geronimo.specs.geronimo-servlet_2.5_spec:1.1.2]
    at org.apache.cxf.transport.servlet.AbstractHTTPServlet.service(AbstractHTTPServlet.java:219)[130:org.apache.cxf.cxf-rt-transports-http:2.7.3]
    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:547)[63:org.eclipse.jetty.servlet:7.5.4.v20111024]
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:480)[63:org.eclipse.jetty.servlet:7.5.4.v20111024]
    at org.ops4j.pax.web.service.jetty.internal.HttpServiceServletHandler.doHandle(HttpServiceServletHandler.java:70)[73:org.ops4j.pax.web.pax-web-jetty:1.0.11]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:119)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:520)[62:org.eclipse.jetty.security:7.5.4.v20111024]
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:227)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:941)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.ops4j.pax.web.service.jetty.internal.HttpServiceContext.doHandle(HttpServiceContext.java:117)[73:org.ops4j.pax.web.pax-web-jetty:1.0.11]
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:409)[63:org.eclipse.jetty.servlet:7.5.4.v20111024]
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:186)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:875)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:117)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:149)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:110)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.Server.handle(Server.java:349)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.HttpConnection.handleRequest(HttpConnection.java:441)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.HttpConnection$RequestHandler.content(HttpConnection.java:936)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:893)[57:org.eclipse.jetty.http:7.5.4.v20111024]
    at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:218)[57:org.eclipse.jetty.http:7.5.4.v20111024]
    at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:50)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:245)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.server.ssl.SslSocketConnector$SslConnectorEndPoint.run(SslSocketConnector.java:663)[61:org.eclipse.jetty.server:7.5.4.v20111024]
    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:598)[55:org.eclipse.jetty.util:7.5.4.v20111024]
    at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:533)[55:org.eclipse.jetty.util:7.5.4.v20111024]
    at java.lang.Thread.run(Thread.java:662)[:1.6.0_33]
Caused by: java.security.cert.CertPathValidatorException: Certificate has been revoked, reason: unspecified
    at sun.security.provider.certpath.PKIXMasterCertPathValidator.validate(PKIXMasterCertPathValidator.java:139)[:1.6.0_33]
    at sun.security.provider.certpath.PKIXCertPathValidator.doValidate(PKIXCertPathValidator.java:330)[:1.6.0_33]
    at sun.security.provider.certpath.PKIXCertPathValidator.engineValidate(PKIXCertPathValidator.java:178)[:1.6.0_33]
    at java.security.cert.CertPathValidator.validate(CertPathValidator.java:250)[:1.6.0_33]
    at org.apache.ws.security.components.crypto.Merlin.verifyTrust(Merlin.java:814)[161:org.apache.ws.security.wss4j:1.6.9]
    ... 45 more
----

==== Encryption Service

===== Encryption Command
An encrypt security command is provided with {branding} that allows plain text to be encrypted. This is useful when displaying password fields in a GUI.

Below is an example of the security:encrypt command used to encrypt the plain text "myPasswordToEncrypt". The output, `bR9mJpDVo8bTRwqGwIFxHJ5yFJzatKwjXjIo/8USWm8=`, is the encrypted value.

----
ddf@local>security:encrypt myPasswordToEncrypt

bR9mJpDVo8bTRwqGwIFxHJ5yFJzatKwjXjIo/8USWm8=
----

==== Redaction and Filtering

Redaction and filtering are performed in a Post Query plugin that occurs after a query has been performed.

===== How Redaction and Filtering Works
Each metacard result will contain security attributes that are pulled from the metadata record after being processed by a PostQueryPlugin that populates this attribute. The security attribute is a HashMap containing a set of keys that map to lists of values. The metacard is then processed by a filter/redaction plugin that creates a KeyValueCollectionPermission from the metacard's security attribute. This permission is then checked against the user subject to determine if the subject has the correct claims to view that metacard. The decision to filter/redact* the metacard eventually relies on the installed PDP (features:install security-pdp-java OR features:install security-pdp-xacml). The PDP that is being used returns a decision, and the metacard will either be filtered/redacted or allowed to pass through.

[NOTE]
====
*The default setting is to redact records*.
====

The security attributes populated on the metacard are completely dependent on the type of the metacard. Each type of metacard must have its own PostQueryPlugin that reads the metadata being returned and populates the metacard's security attribute. If the subject or resource (metacard) permissions are missing during redaction, that resource is redacted.

Example (represented as simple XML for ease of understanding):
[source,xml,linenums]
----
<metacard>
    <security>
        <map>
            <entry key="entry1" value="A,B" />
            <entry key="entry2" value="X,Y" />
            <entry key="entry3" value="USA,GBR" />
            <entry key="entry4" value="USA,AUS" />
        </map>
    </security>
</metacard>
----

[source,xml,linenums]
----
<user>
    <claim name="claim1">
        <value>A</value>
        <value>B</value>
    </claim>
    <claim name="claim2">
        <value>X</value>
        <value>Y</value>
    </claim>
    <claim name="claim3">
        <value>USA</value>
    </claim>
    <claim name="claim4">
        <value>USA</value>
    </claim>
</user>
----

In the above example, the user's claims are represented very simply and are similar to how they would actually appear in a SAML 2 assertion.
Each of these user (or subject) claims will be converted to a KeyValuePermission object.
These permission objects will be implied against the permission object generated from the metacard record.
In this particular case, the metacard might be allowed if the policy is configured appropriately because all of the permissions line up correctly.

===== Filter Policies

The procedure for setting up a policy differs depending on which PDP implementation installed.
The `security-pdp-java` implementation is the simplest PDP to use, so it will be covered here.

. Open the Admin Console at https://localhost:8993/admin
. Click the {branding} Security application tile
. Click the *Configuration* tab
. Click on the Security Simple AuthZ Realm configuration.
. Add any attribute mappings necessary to map between subject claims and metacard values.
.. For example, the above example would require two Match All mappings of claim1=entry1 and claim2=entry2
.. Match One mappings would contain claim3=entry3 and claim4=entry4.

[NOTE]
====
See the Security PDP Java Realm section of this documentation for a description of the configuration page.
====

With the security-pdp-java feature configured in this way, the above Metacard would be displayed to the user.

The XACML PDP is explained in more detail in the XACML Policy Decision Point (PDP) section of this documentation.
It the administrator's responsibility to write a XACML policy capable of returning the correct response message.
The Java-based PDP should perform adequately in most situations.
It is possible to install the security-pdp-java and security-pdp-xacml features at the same time.
The system could be configured in this way in order to allow the Java PDP to handle most cases and only have XACML policies to handle more complex situations than what the Java PDP is designed for.
Keep in mind that this would be a very complex configuration with both PDPs installed, and this should only be performed if you understand the complex details.

===== Standalone Security Token Service (STS) Installation

The STS cannot currently be installed on a kernel distribution of {branding}.
To run a STS-only {branding} installation, uninstall the catalog components that are not being used.
The following list displays the features that can be uninstalled to minimize the runtime size of {branding} in an STS-only mode.
This list is not a comprehensive list of every feature that can be uninstalled; it is a list of the larger components that can be uninstalled without impacting the STS functionality.

.Unnecessary Features
* catalog-core-standardframework
* catalog-solr-embedded-provider
* catalog-opensearch-endpoint
* catalog-opensearch-souce
* catalog-rest-endpoint

===== STS Claims Handlers

Claims handlers are classes that convert the incoming user credentials into a set of attribute claims that will be populated in the SAML assertion.
An example in action would be the LDAPClaimsHandler that takes in the user's credentials and retrieves the user's attributes from a backend LDAP server.
These attributes are then mapped and added to the SAML assertion being created.
Integrators and developers can add more claims handlers that can handle other types of external services that store user attributes.

====== Description

A claim is an additional piece of data about a principal that can be included in a token along with basic token data.
A claims manager provides hooks for a developer to plug in claims handlers to ensure that the STS includes the specified claims in the issued token.

==== XACML Policy Decision Point (PDP)

After unzipping the {branding} distribution, place the desired XACML policy in the <distribution root>/etc/pdp/policies directory.
This is the directory in which the PDP will look for XACML policies every 60 seconds.
A sample XACML policy is located at the end of this page.
Information on specific bundle configurations and names can be found on the Security PDP application page.

===== Creating a Policy
This document assumes familiarity with the XACML schema and does not go into detail on the XACML language.
There are some {branding}-specific items that need to be considered when creating a policy, so it is compatible with the XACMLRealm.
When creating a policy, a target is used to indicate that a certain action should be run only for one type of request.
Targets can be used on both the main policy element and any individual rules.
Generally targets are geared toward the actions that are set in the request.

====== Actions
For {branding}, these actions are populated by various components in the security API.
The actions and their population location are identified in the following table.

[cols="1,1,1,5"]
|===

|Operation
|Action-id Value
|Component Setting the action
|Description

|Filtering / Redaction
|read
|security-pdp-xacmlrealm
|When performing any redaction or filtering, the XACMLRealm will set the action-id to "read".

|Service
|<SOAPAction>
|security-pep-interceptor
|If the PEP Interceptor is added to any SOAP-based web services for service authorization, the action-id will be the SOAPAction of the incoming request. This allows the XACML policy to have specific rules for individual services within the system.

|===

[NOTE]
====
These are only the action-id values that are currently created by the components that come with {branding}.
Additional components can be created and added to {branding} to identify specific action-ids.
====

In the examples below, the policy has specified targets for the above type of calls.
For the Filtering/Redaction code, the target was set for "filter", and the Service validation code targets were geared toward two services: query and LocalSiteName.
In a production environment, these actions for service authorization will generally be full URNs that are described within the SOAP WSDL.

====== Attributes

Attributes for the XACML request are populated with the information in the calling subject and the resource being checked.

====== Subject
The attributes for the subject are obtained from the SAML claims and populated within the XACMLRealm as individual attributes under the urn:oasis:names:tc:xacml:1.0:subject-category:access-subject category. The name of the claim is used for the *AttributeId* value. Examples of the items being populated are available at the end of this page.

====== Resource

The attributes for resources are obtained through the permissions process.
When checking permissions, the XACMLRealm retrieves a list of permissions that should be checked against the subject.
These permissions are populated outside of the realm and should be populated with the security attributes located in the metacard security property.
When the permissions are of a key-value type, the key being used is populated as the AttributeId value under the urn:oasis:names:tc:xacml:3.0:attribute-category:resource category.

===== Example Requests and Responses
The following items are a sample request, response, and the corresponding policy. For the XACML PDP, the request is made by the XACML realm (security-pdp-xacmlrealm), passed to the XACML processing engine (security-pdp-xacmlprocessor), which reads the policy and outputs a response.

====== Policy
This is the sample policy that was used for the following sample request and responses. The policy was made to handle the following actions: filter, query, and LocalSiteName. The filter action is used to compare subject's SUBJECT_ACCESS attributes to metacard's RESOURCE_ACCESS attributes. The query and LocalSiteName actions differ, as they are used to perform service authorization. For a query, the user must be associated with the country code ATA (Antarctica), and a LocalSiteName action can be performed by anyone.

.Policy
[source,xml,linenums]
----
<Policy xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17" PolicyId="xpath-target-single-req" RuleCombiningAlgId="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-overrides" Version="1.0">
    <PolicyDefaults>
        <XPathVersion>http://www.w3.org/TR/1999/REC-xpath-19991116</XPathVersion>
    </PolicyDefaults>
    <Target>
        <AnyOf>
            <AllOf>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">filter</AttributeValue>
                    <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
            </AllOf>
            <AllOf>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">query</AttributeValue>
                    <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
            </AllOf>
            <AllOf>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">LocalSiteName</AttributeValue>
                    <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
            </AllOf>
        </AnyOf>
    </Target>
    <Rule Effect="Permit" RuleId="permit-filter">
        <Target>
            <AnyOf>
                <AllOf>
                    <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                        <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">filter</AttributeValue>
                        <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                    </Match>
                </AllOf>
            </AnyOf>
        </Target>
        <Condition>
            <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-subset">
                <AttributeDesignator AttributeId="RESOURCE_ACCESS" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:resource" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                <AttributeDesignator AttributeId="SUBJECT_ACCESS" Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
            </Apply>
        </Condition>
    </Rule>
    <Rule Effect="Permit" RuleId="permit-action">
        <Target>
            <AnyOf>
                <AllOf>
                    <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                        <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">ATA</AttributeValue>
                        <AttributeDesignator AttributeId="http://www.opm.gov/feddata/CountryOfCitizenship" Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="false"/>
                    </Match>
                    <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                        <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">query</AttributeValue>
                        <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="false"/>
                    </Match>
                </AllOf>
                <AllOf>
                    <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                        <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">LocalSiteName</AttributeValue>
                        <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="false"/>
                    </Match>
                </AllOf>
            </AnyOf>
        </Target>
    </Rule>
    <Rule Effect="Deny" RuleId="deny-read"/>
</Policy>
----

====== Service Authorization

====== Allowed Query

.Request
[source,xml,linenums]
----
<Request xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17" ReturnPolicyIdList="false" CombinedDecision="false">
    <Attributes Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">query</AttributeValue>
        </Attribute>
    </Attributes>
    <Attributes Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:subject:subject-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">users</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">admin</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">A</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">B</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">testuser1</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://www.opm.gov/feddata/CountryOfCitizenship" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">ATA</AttributeValue>
        </Attribute>
    </Attributes>
</Request>
----

.Response
[source,xml,linenums]
----
<Response xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17">
    <Result>
        <Decision>Permit</Decision>
        <Status>
            <StatusCode Value="urn:oasis:names:tc:xacml:1.0:status:ok"/>
        </Status>
    </Result>
</Response>
----

====== Denied Query

.Request
[source,xml,linenums]
----
<Request xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17" ReturnPolicyIdList="false" CombinedDecision="false">
    <Attributes Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">query</AttributeValue>
        </Attribute>
    </Attributes>
    <Attributes Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:subject:subject-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User USA</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">users</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">admin</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">A</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">B</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">testuser1</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://www.opm.gov/feddata/CountryOfCitizenship" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">USA</AttributeValue>
        </Attribute>
    </Attributes>
</Request>
----

.Response
[source,xml,linenums]
----
<Response xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17">
    <Result>
        <Decision>Deny</Decision>
        <Status>
            <StatusCode Value="urn:oasis:names:tc:xacml:1.0:status:ok"/>
        </Status>
    </Result>
</Response>
----

====== Metacard Authorization

====== Subject Permitted
All of the resource's RESOURCE_ACCESS attributes were matched with the Subject's SUBJECT_ACCESS attributes.

.Request
[source,xml,linenums]
----
<Request xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17" ReturnPolicyIdList="false" CombinedDecision="false">
    <Attributes Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">filter</AttributeValue>
        </Attribute>
    </Attributes>
    <Attributes Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:subject:subject-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">users</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">admin</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">testuser1</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">A</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">B</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://www.opm.gov/feddata/CountryOfCitizenship" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">ATA</AttributeValue>
        </Attribute>
    </Attributes>
    <Attributes Category="urn:oasis:names:tc:xacml:3.0:attribute-category:resource">
        <Attribute AttributeId="RESOURCE_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">A</AttributeValue>
        </Attribute>
    </Attributes>
</Request>
----

.Response
[source,xml,linenums]
----
<Response xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17">
    <Result>
        <Decision>Deny</Decision>
        <Status>
            <StatusCode Value="urn:oasis:names:tc:xacml:1.0:status:ok"/>
        </Status>
    </Result>
</Response>
----

====== Subject Denied
The resource had an additional RESOURCE_ACCESS attribute 'C' that the subject did not have.

.Request
[source,xml,linenums]
----
<Request xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17" ReturnPolicyIdList="false" CombinedDecision="false">
    <Attributes Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">filter</AttributeValue>
        </Attribute>
    </Attributes>
    <Attributes Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject">
        <Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:subject:subject-id" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">users</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">admin</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Test User</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">testuser1</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">A</AttributeValue>
        </Attribute>
        <Attribute AttributeId="SUBJECT_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">B</AttributeValue>
        </Attribute>
        <Attribute AttributeId="http://www.opm.gov/feddata/CountryOfCitizenship" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">ATA</AttributeValue>
        </Attribute>
    </Attributes>
    <Attributes Category="urn:oasis:names:tc:xacml:3.0:attribute-category:resource">
        <Attribute AttributeId="RESOURCE_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">A</AttributeValue>
        </Attribute>
        <Attribute AttributeId="RESOURCE_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">B</AttributeValue>
        </Attribute>
        <Attribute AttributeId="RESOURCE_ACCESS" IncludeInResult="false">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">C</AttributeValue>
        </Attribute>
    </Attributes>
</Request>
----

.Response
[source,xml,linenums]
----
<Response xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17">
    <Result>
        <Decision>Deny</Decision>
        <Status>
            <StatusCode Value="urn:oasis:names:tc:xacml:1.0:status:ok"/>
        </Status>
    </Result>
</Response>
----

===== Expansion Service Instances and Configuration
It is expected that multiple instances of the expansion service will be running at the same time. Each instance of the service defines a unique property that is useful for retrieving specific instances of the expansion service. The following table lists the two pre-defined instances used by {branding} for expanding user attributes and metacard attributes respectively.

[cols="1,3,5" options="header"]
|===
|Property Name
|Value
|Description

|mapping
|security.user.attribute.mapping
|This instance is configured with rules that expand the user's attribute values for security checking.

|mapping
|security.metacard.attribute.mapping
|This instance is configured with rules that expand the metacard's security attributes before comparing with the user's attributes.

|===

Each instance of the expansion service can be configured using a configuration file.
The configuration file can have three different types of lines:
* comments - any line prefixed with the # character is ignored as a comment (for readability, blank lines are also ignored)
* attribute separator - a line starting with separator= defines the attribute separator string.
* rule - all other lines are assumed to be rules defined in a string format `<key>:<original value>:<new value>`

The following configuration file defines the rules shown above in the example table (using the space as a separator):

----
# This defines the separator that will be used when the expansion string contains multiple
# values - each will be separated by this string. The expanded string will be split at the
# separator string and each resulting attributed added to the attribute set (duplicates are
# suppressed). No value indicates the defualt value of ' ' (space).
separator=

# The following rules define the attribute expansion to be performed. The rules are of the
# form:
#       <attribute name>:<original value>:<expanded value>
# The rules are ordered, so replacements from the first rules may be found in the original
# values of subsequent rules.
Location:Goodyear:Goodyear AZ
Location:AZ:AZ USA
Location:CA:CA USA
Title:VP-Sales:VP-Sales VP Sales
Title:VP-Engineering:VP-Engineering VP Engineering
----

==== Expansion Commands
[cols="2,1,4" options="header"]
|===

|Title
|Namespace
|Description

|{branding}::Security::Expansion::Commands
|security
|The expansion commands provide detailed information about the expansion rules in place and the ability to see the results of expanding specific values against the active rule set.

|===

===== Expansion Commands
[cols="2"]
|===
|security:expand        |security:expansions
|===

===== Command Descriptions

[cols="1,5" options="header"]
|===

|Command
|Description

|expand
|Runs the expansion service on the provided data returning the expanded value.

|expansions
|Dumps the ruleset for each active expansion service.

|===

===== Expansion Command Examples and Explanation

====== `security:expansions`
The `security:expansions` command dumps the ruleset for each active expansion service.
It takes no arguments and displays each rule on a separate line in the form: `<attribute name> : <original string> : <expanded string>`.
The following example shows the results of executing the expansions command with no active expansion service.

[source]
----
ddf@local>security:expansions
No expansion services currently available.
----

After installing the expansions service and configuring it with an appropriate set of rules, the expansions command will provide output similar to the following:

[source]
----
ddf@local>security:expansions
Location : Goodyear : Goodyear AZ
Location : AZ : AZ USA
Location : CA : CA USA
Title : VP-Sales : VP-Sales VP Sales
Title : VP-Engineering : VP-Engineering VP Engineering
----

===== `security:expand`

The security:expand command runs the expansion service on the provided data.
It takes an attribute and an original value, expands the original value using the current expansion service and rule set and dumps the results.
For the rule set shown above, the expand command produces the following results:

[source]
----
ddf@local>security:expand Location Goodyear
[Goodyear, USA, AZ]

ddf@local>security:expand Title VP-Engineering
[VP-Engineering, Engineering, VP]

ddf@local>expand Title "VP-Engineering Manager"
[VP-Engineering, Engineering, VP, Manager]
----

==== Configure WSS Using Standalone Servers

{branding} uses SAML 2.0 Web SSO as its single sign-on service. {branding} uses LDAP and STS to keep track of users and user attributes. SAML, LDAP, and STS are integral, interconnected components of the {branding} security scheme, and all can be installed on a local {branding} instance with only a few feature installs. Setting up these authentication components to run externally, however, is more nuanced, so this page will provide step-by-step instructions detailing the configuration process.

If using different keystore names, substitute the name provided in this document with the desired name for your setup. For this document, the following data is used:

[cols="1,2,5"]
|===

|Server
|Keystore File
|Comments

|{branding}
|serverKeystore.jks
|Keystore used for SSL/TLS connections.

|===

link:Distributed WSS.pptx[Distributed WSS]

.Login Authentication Scheme
image::login_authentication_scheme.jpg[Login Authentication Scheme]

==== Authentication Components
It is implied that the three authentication components identified below are installed on three separate servers. Therefore, it is important to keep track of the DNS hostnames used on each server for certificate authentication purposes.

===== LDAP
LDAP is used to maintain a list of trusted {branding} users and the attributes associated with them. The STS can use LDAP as a user store and queries LDAP for user attributes and converts them to SAML claims.

. Start the DDF distribution.
. Run the installer at https://localhost:8993/admin (default username/password is admin/admin)
. After the installer completes, Click the *Manage* button in the upper right hand corner of the Admin Console
. Click the *Play* button on the Opendj Embedded tile in order to install that application

[WARNING]
====
It is very important that the keystore file used in the process is set up to trust the hostnames used by CAS and STS. If it is not, there will be certificate authentication issues for the user.
====

===== Idp (Identity Provider) and SP (Service Provider)
IdP and SP are used for SSO authentication purposes.

. Install the security-idp feature either by command line: "features:install security-idp", or by the Admin Console: {branding} Security -> Features -> security-idp

===== STS
The Security Token Service, unlike the LDAP, cannot currently be installed on a kernel distribution of {branding}. To run an STS-only {branding} installation,  uninstall the catalog components that are not being used. This will increase performance. A list of unneeded components can be found on the STS page. The STS is installed by default in DDF.

. Verify that the serverKeystores.jks file in `/etc/keystores` trusts the hostnames used in your environment (the hostnames of LDAP, and any {branding} users that make use of this STS server).
. Start the distribution.
. Run the installer at https://localhost:8993/admin (default username/password is admin/admin)
. After the installer completes, Click the {branding} Security application tile
. Click the *Features* tab
. Install security-sts-ldaplogin and security-sts-ldapclaimshandler features by clicking the *Play* button next to each
. Open the {branding} Admin Console as an administrator (https://localhost:8993/admin). The default user is "admin" with a password of "admin" (no quotes).
. Click the {branding} Security application tile
. Click the *Configuration* tab
. Open the Security STS LDAP Login configuration.
. Verify that the *LDAP URL*, *LDAP Bind User DN*, and *LDAP Bind User Password* fields match your LDAP server's information. The default {branding} LDAP settings will match up with the default settings of the OpenDJ embedded LDAP server. If not using the embedded LDAP server, change these values to map to the location and settings of the LDAP server being used.
. Select the *Save changes* button if changes were made.
. Open the *Security STS LDAP and Roles Claims Handler* configuration.
. Populate the same URL, user, and password fields with your LDAP server information.
. Select the *Save changes* button.

All of the authentication components should be running and configured at this point. The final step is to configure a {branding} instance, so this authentication scheme is used.

==== Configuring {branding}
Once everything is configured and running, hooking up an existing {branding} instance to the authentication scheme is performed by setting a few configuration properties.

. Open the *Web Context Policy Manager* configuration.
.. Under *Context Realms* add the contexts that should be protected under the ldap realm
... The default setting is /=karaf, the karaf realm refers to the user.properties user store file located in the <ddf.home>/etc directory. This can be changed to /=ldap, if it is desired that the entire container be protected under ldap. If the /admin context is changed to something other than the default (karaf), it will be required that you refresh the page in order to log in again, or your changes may not be saved. This includes changing the root context to something other than karaf, without specifically setting /admin to a realm. The policies for all contexts will roll up, for example: the /admin context policy will roll up to the karaf realm with the default configuration because / is higher in the context heirarchy than /admin and no realm is specifically set for /admin.
.. Under *Authentication Types*, make any desired authentication changes to contexts.
... In order to use the SAML 2.0 Web SSO profile against a context, you must specify only the IDP authentication type
. Open the *Security STS Client* configuration. Verify that the host/port information in the *STS Address* field points to your STS server. If you are using the default bundled STS, this information will already be correct.

The {branding} should now use the SSO/STS/LDAP servers when it attempts to authenticate a user upon an attempted log in.

==== Hardening

These instructions demonstrate how to harden a {branding} system for a more secure installation.

[WARNING]
====
The Admin Console is not compatible with Internet Explorer 9.
====

==== Disable the Felix Web Console

To harden {branding} for security purposes, disable the Web Console, so users do not have access. All configuration is performed using the {branding} command line console and/or .cfg configuration files.

----
features:uninstall webconsole
----

. To re-enable the Felix Web Console, open the Karaf command line console and install the `webconsole` feature.

----
features:install webconsole
----

==== Disable the Admin Console

----
features:uninstall admin-ui
----

. To re-enable the Admin Console, open the Karaf command line console and install the `admin-ui` feature.

----
features:install admin-ui
----

===== Enable SSL for Clients
In order for outbound secure connections (HTTPS) to be made from components like Federated Sources and Resource Readers configuration may need to be updated with keystores and security properties.
These values are configured in the `<DDF_INSTALL_DIR>/etc/system.properties` file. The following values can be set:

[cols="3" options="header"]
|===

|Property
|Sample Value
|Description

|javax.net.ssl.trustStore
|etc/keystores/serverTruststore.jks
|The java keystore that contains the trusted public certificates for Certificate Authorities (CA's) that can be used to validate SSL Connections for outbound TLS/SSL connections (e.g. HTTPS).
When making outbound secure connections a handshake will be done with the remote secure server and the CA that is in the signing chain for the remote server's certificate must be present in the trust store for the secure connection to be successful.

|javax.net.ssl.trustStorePassword
|changeit
|This is the password for the truststore listed in the above property

|javax.net.ssl.keyStore
|etc/keystores/serverKeystore.jks
|The keystore that contains the private key for the local server that can be used for signing, encryption, and SSL/TLS.

|javax.net.ssl.keyStorePassword
|changeit
|The password for the keystore listed above

|javax.net.ssl.keyStoreType
|jks
|The type of keystore

|https.cipherSuites
|TLS_DHE_RSA_WITH_AES_128_CBC_SHA,
TLS_DHE_RSA_WITH_AES_128_CBC_SHA,
TLS_DHE_DSS_WITH_AES_128_CBC_SHA,
TLS_RSA_WITH_AES_128_CBC_SHA
|The cipher suites that are supported when making outbound HTTPS connections

|https.protocols
|TLSv1.1,TLSv1.2
|The protocols that are supported when making outbound HTTPS connections

|===

===== Configure {branding} without the Admin Console

[NOTE]
====
Depending on the environment, it may be easier for integrators and administrators to configure {branding} using the Admin Console prior to disabling it for hardening purposes.
The Admin Console can be re-enabled for additional configuration changes.
====
In an environment hardened for security purposes, access to the {branding} Admin Console or the Felix Web Console might be denied.
It is necessary to configure {branding} (e.g., providers, Schematron rulesets, etc.) using .config configuration files or the Admin Console. Configuration via the Karaf command line console is not supported and may result in configuration errors.
The OSGi container detects the addition, updating, or deletion of `.config` files in the `etc/` directory.
The following sections describe how to configure each {branding} item using both of these mechanisms.
A template file is provided for each configurable {branding} item so that it can be copied/renamed then modified with the appropriate settings.

[WARNING]
====
If at a later time the Admin Console is enabled again, all of the configuration done via .config files is loaded and displayed.
However, note that the name of the .config file is not used in the Admin Console.
Rather, OSGi assigns a universally unique identifier (UUID) when the {branding} item was created and displays this UUID in the console (e.g., OpenSearchSource.112f298e-26a5-4094-befc-79728f216b9b)
====

Templates included with {branding}:

[cols="1,4,4,1" options="header"]
|===

|{branding} Service
|Template File Name
|Factory PID
|Configurable Properties (from {branding} User's Guide)

|{branding} Catalog Framework
|ddf.catalog.impl.service.CatalogFrameworkImpl.cfg
|ddf.catalog.CatalogFrameworkImpl
|Standard Catalog Framework

|===

===== Configure Using a .cfg File Template
The following steps define the procedure for configuring a new source or feature using a config file.

. Copy/rename the provided template file in the etc/templates directory to the etc directory. (Refer to the table above to determine correct template.)
.. *Mandatory*: The dash between the PID (e.g., `OpenSearchSource_site.cfg`) and the instance name (e.g., `OpenSearchSource_site.cfg`) is required. The dash is a reserved character used by OSGi that identifies instances of a managed service factory that should be created.
.. Not required, but a good practice is to change the instance name (e.g., `federated_source`) of the file to something identifiable (`source1- ddf`).
. Edit the copied file to etc with the settings for the configuration. (Refer to the table above to determine the configurable properties).
.. This file is a Java properties file, hence the syntax is `<key>` = `<value>`.
.. Consult the inline comments in the file for guidance on what to modify.
.. The Configurable Properties tables in the Integrator's Guide for the Included Catalog Components also describe each field and its value.

The new service can now be used as if it was created using the Admin Console.

===== Configure Using the Command Line Console

Configuration via the Karaf command line console is not supported and may result in configuration errors.

==== Directory Permissions

.{branding}_HOME
[NOTE]
====
{branding} is installed in the {branding}_HOME directory.
====

===== Directory Permissions on Windows
Restrict access to sensitive files by ensuring that the only users with access privileges are administrators.

. Right-click on the file or directory noted below then select *Full Control → Administrators → System*.
. Click *Properties → Security → Advanced* and select Creator Owner for `DDF_HOME` (e.g., `C:\ddf`).
. Restrict access to sensitive files by ensuring that only *System* and *Administrators* have Full Control to the below files by right-clicking on the file or directory below then selecting *Properties → Security → Advanced*.
. Delete any other groups or users listed with access to `DDF_HOME/etc` and `DDF_HOME/deploy`.

===== Directory Permissions on *NIX
Protect the {branding} from unauthorized access.

. As root, change the owner and group of critical {branding} directories to the NON_ROOT_USER.
+
[WARNING]
====
A NON_ROOT_USER (e.g., ddf) is recommended for installation.
====
+
[source, bash, linenums]
----
chown -R NON_ROOT_USER $DDF_HOME $DDF_HOME/etc $DDF_HOME/data
chgrp -R NON_ROOT_USER $DDF_HOME/etc $DDF_HOME/data
chmod -R og-w $DDF_HOME/etc $DDF_HOME/data
----
+
. Restrict access to sensitive files by ensuring that the only users with “group” permissions (e.g., ddf-group) have access.
. Execute the following command on the above files (examples assume {branding}_HOME is /opt/ddf):
+
[source,bash]
----
chmod -R o /opt/ddf
----
+
. As the the application owner (e.g., ddf user), restrict access to sensitive files.
+
[source,bash,linenums]
----
chmod 640 /opt/ddf/etc
chmod 640 /opt/ddf/deploy
----

[IMPORTANT]
====
The system administrator must restrict certain directories to ensure that the application (user) cannot access restricted directories on the system. For example the NON_ROOT_USER should only have read access to `/opt/ddf`.
====

==== Deployment Guidelines

{branding} relies on the Directory Permissions of the host platform to protect the integrity of the {branding} during operation. System administrators should perform the following steps when deploying bundles added to the {branding}.

. Prior to allowing a hot deployment, check the available storage space on the system to ensure the deployment will not exceed the available space.
. Set maximum storage space on the `DDF_HOME/deploy` and `DDF_HOME/system` directories to restrict the amount of space used by deployments.
. Do not assume the deployment is from a trusted source; verify its origination.
. Use the source code to verify a deployment is required for {branding} to prevent unnecessary/vulnerable deployments.

===== Endpoint Schema Validation
SOAP Web Services may have WSDL validation enabled. Ensure that the bundle has WSDL schema validation enabled. These instructions assume the implementation made use of the Spring beans model. All {branding} endpoint bundles follow this model.

. Prior to deploying a bundle/feature, verify the schema validation if it is a {branding} endpoint.
. Modify the `beans.xml` file
.. In a terminal window, change directory to the feature directory under the {branding} installation directory.
+
[source,bash]
----
cd DDF_HOME/system/com/lmco/ddf/endpoint-bundle.jar
----
+
Unzip the endpoint-bundle.jar.
+
[source,bash]
----
unzip endpoint-bundle.jar
----
+
.. Change directory to the `beans.xml` file.
+
[source,bash]
----
cd META-INF/spring
----
.. Open the `beans.xml` file in an editor (e.g., vi).
.. Search for `schema-validation-enabled` and change its value to true.
+
[source,bash]
----
<entry key="schema-validation-enabled" value="true"/>
----
.. Save and close the file.
.. Change directory to the feature directory,
+
[source,bash]
----
cd ../..
----
+
. Recreate the jar file (use zip or another archive tool).
+
[source,bash]
----
zip endpoint-bundle.jar *
----
+
. Re-install the feature.
.. Open the Web browser and navigate to the {branding} Admin Console,
.. Select the Install button. Schema validation is now enabled for the endpoint.

==== Assuring Authenticity

{branding} Artifacts in the JAR file format (such as bundles or {branding} applications packaged as KAR files) can be signed and verified using the tools included as part of the Java Runtime Environment.

===== Prerequisites
To work with Java signatures, a keystore/truststore is required.
For the purposes of this example we'll sign and validate using a self signed certificate which can be generated with the keytool utility.
In production a certificate issued from a trusted Certificate Authority should be used.

Additional documentation on keytool can be found at http://docs.oracle.com/javase/6/docs/technotes/tools/windows/keytool.html

.Using keytool to generate a self-signed certificate keystore
[source]
----
~ $ keytool -genkey -keyalg RSA -alias selfsigned -keystore keystore.jks -storepass password -validity 360 -keysize 2048
What is your first and last name?
  [Unknown]:  Nick Fury
What is the name of your organizational unit?
  [Unknown]:  Marvel
What is the name of your organization?
  [Unknown]:  SHIELD
What is the name of your City or Locality?
  [Unknown]:  New York
What is the name of your State or Province?
  [Unknown]:  NY
What is the two-letter country code for this unit?
  [Unknown]:  US
Is CN=Nick Fury, OU=SHIELD, O=Marvel, L="New  York", ST=NY, C=US correct?
  [no]:  yes
Enter key password for <selfsigned>
    (RETURN if same as keystore password):
Re-enter new password:
----

===== Signing a JAR/KAR
Once a keystore is available, the // TODO: find the rest of this sentence.

Additional documentation on jarsigner can be found at http://docs.oracle.com/javase/6/docs/technotes/tools/windows/jarsigner.html

.Using jarsigner to sign a KAR
[source]
----
~ $ jarsigner -keystore keystore.jks -keypass shield -storepass password  catalog-app-2.5.1.kar selfsigned
----

===== Verifying a JAR/KAR
The jarsigner utility is also used to verify a signature in a JAR-formatted file.

.Using jarsigner to verify a file
[source]
----
~ $ jarsigner -verify -verbose -keystore keystore.jks catalog-app-2.5.1.kar
        9447 Mon Oct 06 17:05:46 MST 2014 META-INF/MANIFEST.MF
        9503 Mon Oct 06 17:05:46 MST 2014 META-INF/SELFSIGN.SF
        1303 Mon Oct 06 17:05:46 MST 2014 META-INF/SELFSIGN.RSA
           0 Wed Sep 17 17:14:06 MST 2014 META-INF/
           0 Wed Sep 17 17:14:10 MST 2014 META-INF/maven/
           0 Wed Sep 17 17:14:10 MST 2014 META-INF/maven/ddf.catalog/
           0 Wed Sep 17 17:14:10 MST 2014 META-INF/maven/ddf.catalog/catalog-app/
smk     4080 Wed Sep 17 16:54:18 MST 2014 META-INF/maven/ddf.catalog/catalog-app/pom.xml
smk      107 Wed Sep 17 17:14:06 MST 2014 META-INF/maven/ddf.catalog/catalog-app/pom.properties
           0 Wed Sep 17 17:14:06 MST 2014 repository/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/catalog/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/catalog/catalog-app/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/catalog/catalog-app/2.5.1/
smk    12543 Wed Sep 17 17:14:06 MST 2014 repository/ddf/catalog/catalog-app/2.5.1/catalog-app-2.5.1-features.xml
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/catalog/core/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/catalog/core/catalog-core-api/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/catalog/core/catalog-core-api/2.5.1/
smk   188995 Wed Sep 17 16:55:28 MST 2014 repository/ddf/catalog/core/catalog-core-api/2.5.1/catalog-core-api-2.5.1.jar
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/mime/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/mime/core/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/mime/core/mime-core-api/
           0 Wed Sep 17 17:14:06 MST 2014 repository/ddf/mime/core/mime-core-api/2.5.0/
smk     4396 Wed Sep 10 12:38:24 MST 2014 repository/ddf/mime/core/mime-core-api/2.5.0/mime-core-api-2.5.0.jar
           0 Wed Sep 17 17:14:06 MST 2014 repository/org/
           0 Wed Sep 17 17:14:06 MST 2014 repository/org/apache/
           0 Wed Sep 17 17:14:06 MST 2014 repository/org/apache/tika/
           0 Wed Sep 17 17:14:06 MST 2014 repository/org/apache/tika/tika-core/
           0 Wed Sep 17 17:14:06 MST 2014 repository/org/apache/tika/tika-core/1.2/
smk   463945 Thu Feb 13 09:26:04 MST 2014 repository/org/apache/tika/tika-core/1.2/tika-core-1.2.jar
           0 Wed Sep 17 17:14:06 MST 2014 repository/org/apache/tika/tika-bundle/
           0 Wed Sep 17 17:14:06 MST 2014 repository/org/apache/tika/tika-bundle/1.2/
smk   22360866 Thu Feb 13 09:26:54 MST 2014 repository/org/apache/tika/tika-bundle/1.2/tika-bundle-1.2.jar
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/gt-opengis/
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/gt-opengis/8.4_1/
smk   2335529 Thu Feb 13 09:32:42 MST 2014 repository/org/codice/thirdparty/gt-opengis/8.4_1/gt-opengis-8.4_1.jar
           0 Wed Sep 17 17:14:08 MST 2014 repository/ddf/catalog/core/catalog-core-commons/
           0 Wed Sep 17 17:14:08 MST 2014 repository/ddf/catalog/core/catalog-core-commons/2.5.1/
smk    38441 Wed Sep 17 16:56:10 MST 2014 repository/ddf/catalog/core/catalog-core-commons/2.5.1/catalog-core-commons-2.5.1.jar
           0 Wed Sep 17 17:14:08 MST 2014 repository/ddf/catalog/core/catalog-core-camelcomponent/
           0 Wed Sep 17 17:14:08 MST 2014 repository/ddf/catalog/core/catalog-core-camelcomponent/2.5.1/
smk   103672 Wed Sep 17 16:57:30 MST 2014 repository/ddf/catalog/core/catalog-core-camelcomponent/2.5.1/catalog-core-camelcomponent-2.5.1.jar
           0 Wed Sep 17 17:14:08 MST 2014 repository/ddf/measure/
           0 Wed Sep 17 17:14:08 MST 2014 repository/ddf/measure/measure-api/
           0 Wed Sep 17 17:14:08 MST 2014 repository/ddf/measure/measure-api/2.5.1/
smk   609307 Wed Sep 17 16:54:52 MST 2014 repository/ddf/measure/measure-api/2.5.1/measure-api-2.5.1.jar
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/picocontainer/
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/picocontainer/1.2_1/
smk    10819 Thu Feb 13 09:32:42 MST 2014 repository/org/codice/thirdparty/picocontainer/1.2_1/picocontainer-1.2_1.jar
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/vecmath/
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/vecmath/1.3.2_1/
smk    90446 Thu Feb 13 09:32:42 MST 2014 repository/org/codice/thirdparty/vecmath/1.3.2_1/vecmath-1.3.2_1.jar
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/geotools-suite/
           0 Wed Sep 17 17:14:08 MST 2014 repository/org/codice/thirdparty/geotools-suite/8.4_1/
smk   25175516 Thu Feb 13 09:33:40 MST 2014 repository/org/codice/thirdparty/geotools-suite/8.4_1/geotools-suite-8.4_1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/codice/thirdparty/jts/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/codice/thirdparty/jts/1.12_1/
smk   663441 Thu Feb 13 09:33:44 MST 2014 repository/org/codice/thirdparty/jts/1.12_1/jts-1.12_1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-federationstrategy/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-federationstrategy/2.5.1/
smk   155049 Wed Sep 17 17:01:02 MST 2014 repository/ddf/catalog/core/catalog-core-federationstrategy/2.5.1/catalog-core-federationstrategy-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/codice/thirdparty/lucene-core/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/codice/thirdparty/lucene-core/3.0.2_1/
smk   1041824 Thu Feb 13 09:33:48 MST 2014 repository/org/codice/thirdparty/lucene-core/3.0.2_1/lucene-core-3.0.2_1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/ddf-pubsub/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/ddf-pubsub/2.5.1/
smk   152993 Wed Sep 17 16:58:18 MST 2014 repository/ddf/catalog/core/ddf-pubsub/2.5.1/ddf-pubsub-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-eventcommands/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-eventcommands/2.5.1/
smk    11132 Wed Sep 17 17:01:10 MST 2014 repository/ddf/catalog/core/catalog-core-eventcommands/2.5.1/catalog-core-eventcommands-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/ddf-pubsub-tracker/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/ddf-pubsub-tracker/2.5.1/
smk     6130 Wed Sep 17 17:05:52 MST 2014 repository/ddf/catalog/core/ddf-pubsub-tracker/2.5.1/ddf-pubsub-tracker-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-urlresourcereader/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-urlresourcereader/2.5.1/
smk    84648 Wed Sep 17 16:57:00 MST 2014 repository/ddf/catalog/core/catalog-core-urlresourcereader/2.5.1/catalog-core-urlresourcereader-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/filter-proxy/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/filter-proxy/2.5.1/
smk    33497 Wed Sep 17 16:56:24 MST 2014 repository/ddf/catalog/core/filter-proxy/2.5.1/filter-proxy-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-commands/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-commands/2.5.1/
smk   664977 Wed Sep 17 16:56:34 MST 2014 repository/ddf/catalog/core/catalog-core-commands/2.5.1/catalog-core-commands-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-metacardgroomerplugin/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-metacardgroomerplugin/2.5.1/
smk    31421 Wed Sep 17 17:06:04 MST 2014 repository/ddf/catalog/core/catalog-core-metacardgroomerplugin/2.5.1/catalog-core-metacardgroomerplugin-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/metacard-type-registry/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/metacard-type-registry/2.5.1/
smk     6349 Wed Sep 17 17:05:58 MST 2014 repository/ddf/catalog/core/metacard-type-registry/2.5.1/metacard-type-registry-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-standardframework/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-standardframework/2.5.1/
smk   4930895 Wed Sep 17 16:58:40 MST 2014 repository/ddf/catalog/core/catalog-core-standardframework/2.5.1/catalog-core-standardframework-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-resourcesizeplugin/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-resourcesizeplugin/2.5.1/
smk   4889822 Wed Sep 17 17:06:42 MST 2014 repository/ddf/catalog/core/catalog-core-resourcesizeplugin/2.5.1/catalog-core-resourcesizeplugin-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/fanout-catalogframework/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/fanout-catalogframework/2.5.1/
smk   9707692 Wed Sep 17 17:01:20 MST 2014 repository/ddf/catalog/core/fanout-catalogframework/2.5.1/fanout-catalogframework-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-metricsplugin/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-metricsplugin/2.5.1/
smk   708240 Wed Sep 17 16:57:38 MST 2014 repository/ddf/catalog/core/catalog-core-metricsplugin/2.5.1/catalog-core-metricsplugin-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-sourcemetricsplugin/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/core/catalog-core-sourcemetricsplugin/2.5.1/
smk   709297 Wed Sep 17 17:06:14 MST 2014 repository/ddf/catalog/core/catalog-core-sourcemetricsplugin/2.5.1/catalog-core-sourcemetricsplugin-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/schematron/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/schematron/catalog-schematron-plugin/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/schematron/catalog-schematron-plugin/2.5.1/
smk    19034 Wed Sep 17 17:09:08 MST 2014 repository/ddf/catalog/schematron/catalog-schematron-plugin/2.5.1/catalog-schematron-plugin-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/rest/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/rest/catalog-rest-endpoint/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/rest/catalog-rest-endpoint/2.5.1/
smk   151862 Wed Sep 17 17:12:54 MST 2014 repository/ddf/catalog/rest/catalog-rest-endpoint/2.5.1/catalog-rest-endpoint-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/opensearch/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/opensearch/catalog-opensearch-endpoint/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/opensearch/catalog-opensearch-endpoint/2.5.1/
smk   465789 Wed Sep 17 17:12:26 MST 2014 repository/ddf/catalog/opensearch/catalog-opensearch-endpoint/2.5.1/catalog-opensearch-endpoint-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-extensions-opensearch/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-extensions-opensearch/1.1.3/
smk    33785 Thu Feb 13 09:31:18 MST 2014 repository/org/apache/abdera/abdera-extensions-opensearch/1.1.3/abdera-extensions-opensearch-1.1.3.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-server/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-server/1.1.3/
smk   162766 Thu Feb 13 09:31:18 MST 2014 repository/org/apache/abdera/abdera-server/1.1.3/abdera-server-1.1.3.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/opensearch/catalog-opensearch-source/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/opensearch/catalog-opensearch-source/2.5.1/
smk   136957 Wed Sep 17 17:13:04 MST 2014 repository/ddf/catalog/opensearch/catalog-opensearch-source/2.5.1/catalog-opensearch-source-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/commons-codec/
           0 Wed Sep 17 17:14:10 MST 2014 repository/commons-codec/commons-codec/
           0 Wed Sep 17 17:14:10 MST 2014 repository/commons-codec/commons-codec/1.4/
smk    58160 Thu Feb 13 09:33:48 MST 2014 repository/commons-codec/commons-codec/1.4/commons-codec-1.4.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.axiom-impl/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.axiom-impl/1.2.12-2/
smk   121899 Thu Feb 13 09:33:48 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.axiom-impl/1.2.12-2/org.apache.servicemix.bundles.axiom-impl-1.2.12-2.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/ws/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/ws/commons/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/ws/commons/axiom/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/ws/commons/axiom/axiom-api/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/ws/commons/axiom/axiom-api/1.2.10/
smk   417361 Thu Feb 13 09:33:50 MST 2014 repository/org/apache/ws/commons/axiom/axiom-api/1.2.10/axiom-api-1.2.10.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-core/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-core/1.1.3/
smk   160895 Thu Feb 13 09:24:52 MST 2014 repository/org/apache/abdera/abdera-core/1.1.3/abdera-core-1.1.3.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-client/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-client/1.1.3/
smk    62059 Thu Feb 13 09:24:52 MST 2014 repository/org/apache/abdera/abdera-client/1.1.3/abdera-client-1.1.3.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-i18n/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-i18n/1.1.3/
smk   622568 Thu Feb 13 09:24:54 MST 2014 repository/org/apache/abdera/abdera-i18n/1.1.3/abdera-i18n-1.1.3.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.abdera-parser/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.abdera-parser/1.1.3_1/
smk   1379508 Thu Feb 13 09:33:54 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.abdera-parser/1.1.3_1/org.apache.servicemix.bundles.abdera-parser-1.1.3_1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.dom4j/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.dom4j/1.6.1_5/
smk   325676 Thu Feb 13 09:33:56 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.dom4j/1.6.1_5/org.apache.servicemix.bundles.dom4j-1.6.1_5.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.jdom/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.jdom/1.1.2_1/
smk   160101 Thu Feb 13 09:33:56 MST 2014 repository/org/apache/servicemix/bundles/org.apache.servicemix.bundles.jdom/1.1.2_1/org.apache.servicemix.bundles.jdom-1.1.2_1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/codice/thirdparty/commons-httpclient/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/codice/thirdparty/commons-httpclient/3.1.0_1/
smk   306098 Thu Feb 13 09:33:56 MST 2014 repository/org/codice/thirdparty/commons-httpclient/3.1.0_1/commons-httpclient-3.1.0_1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/plugin/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/plugin/plugin-federation-replication/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/plugin/plugin-federation-replication/2.5.1/
smk     8986 Wed Sep 17 17:12:02 MST 2014 repository/ddf/catalog/plugin/plugin-federation-replication/2.5.1/plugin-federation-replication-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-metadata/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-metadata/2.5.1/
smk    32559 Wed Sep 17 17:09:44 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-metadata/2.5.1/catalog-transformer-metadata-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-thumbnail/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-thumbnail/2.5.1/
smk    32578 Wed Sep 17 17:09:52 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-thumbnail/2.5.1/catalog-transformer-thumbnail-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/service-xslt-transformer/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/service-xslt-transformer/2.5.1/
smk    47227 Wed Sep 17 17:09:28 MST 2014 repository/ddf/catalog/transformer/service-xslt-transformer/2.5.1/service-xslt-transformer-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-resource/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-resource/2.5.1/
smk    83019 Wed Sep 17 17:09:34 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-resource/2.5.1/catalog-transformer-resource-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/tika-input-transformer/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/tika-input-transformer/2.5.1/
smk    32522 Wed Sep 17 17:10:06 MST 2014 repository/ddf/catalog/transformer/tika-input-transformer/2.5.1/tika-input-transformer-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/geojson-metacard-transformer/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/geojson-metacard-transformer/2.5.1/
smk     9004 Wed Sep 17 17:10:22 MST 2014 repository/ddf/catalog/transformer/geojson-metacard-transformer/2.5.1/geojson-metacard-transformer-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/geojson-queryresponse-transformer/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/geojson-queryresponse-transformer/2.5.1/
smk    53446 Wed Sep 17 17:10:28 MST 2014 repository/ddf/catalog/transformer/geojson-queryresponse-transformer/2.5.1/geojson-queryresponse-transformer-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/geojson-input-transformer/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/geojson-input-transformer/2.5.1/
smk    35487 Wed Sep 17 17:10:16 MST 2014 repository/ddf/catalog/transformer/geojson-input-transformer/2.5.1/geojson-input-transformer-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/service-atom-transformer/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/service-atom-transformer/2.5.1/
smk    38484 Wed Sep 17 17:10:40 MST 2014 repository/ddf/catalog/transformer/service-atom-transformer/2.5.1/service-atom-transformer-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-extensions-geo/
           0 Wed Sep 17 17:14:10 MST 2014 repository/org/apache/abdera/abdera-extensions-geo/1.1.3/
smk    28410 Thu Feb 13 09:24:52 MST 2014 repository/org/apache/abdera/abdera-extensions-geo/1.1.3/abdera-extensions-geo-1.1.3.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/common/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/common/geo-formatter/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/common/geo-formatter/2.5.1/
smk    15970 Wed Sep 17 16:55:18 MST 2014 repository/ddf/catalog/common/geo-formatter/2.5.1/geo-formatter-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/com/
           0 Wed Sep 17 17:14:10 MST 2014 repository/com/googlecode/
           0 Wed Sep 17 17:14:10 MST 2014 repository/com/googlecode/json-simple/
           0 Wed Sep 17 17:14:10 MST 2014 repository/com/googlecode/json-simple/json-simple/
           0 Wed Sep 17 17:14:10 MST 2014 repository/com/googlecode/json-simple/json-simple/1.1.1/
smk    23931 Thu Feb 13 09:24:52 MST 2014 repository/com/googlecode/json-simple/json-simple/1.1.1/json-simple-1.1.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-xml/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-xml/2.5.1/
smk   1954994 Wed Sep 17 17:11:02 MST 2014 repository/ddf/catalog/transformer/catalog-transformer-xml/2.5.1/catalog-transformer-xml-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/commons-collections/
           0 Wed Sep 17 17:14:10 MST 2014 repository/commons-collections/commons-collections/
           0 Wed Sep 17 17:14:10 MST 2014 repository/commons-collections/commons-collections/3.2.1/
smk   575389 Thu Feb 13 09:24:34 MST 2014 repository/commons-collections/commons-collections/3.2.1/commons-collections-3.2.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/security/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/security/catalog-security-filter/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/security/catalog-security-filter/2.5.1/
smk     6492 Wed Sep 17 17:13:40 MST 2014 repository/ddf/catalog/security/catalog-security-filter/2.5.1/catalog-security-filter-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/security/catalog-security-plugin/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/security/catalog-security-plugin/2.5.1/
smk     5463 Wed Sep 17 17:13:50 MST 2014 repository/ddf/catalog/security/catalog-security-plugin/2.5.1/catalog-security-plugin-2.5.1.jar
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/security/catalog-security-logging/
           0 Wed Sep 17 17:14:10 MST 2014 repository/ddf/catalog/security/catalog-security-logging/2.5.1/
smk     6768 Wed Sep 17 17:13:58 MST 2014 repository/ddf/catalog/security/catalog-security-logging/2.5.1/catalog-security-logging-2.5.1.jar
  s = signature was verified
  m = entry is listed in manifest
  k = at least one certificate was found in keystore
  i = at least one certificate was found in identity scope
jar verified.
----

Note the last line: _jar verified_. This indicates that the signatures used to sign the JAR (or in this case, KAR) were valid according to the trust relationships specified by the keystore.

==== Security

===== Configure STS Subject DN constraints
The configuration for the STS Subject DN constraints is located in the `ws-security.subject.cert.constraints property` in the `<DDF_INSTALL_DIR>/etc/system.properties` file.

The default constraints are ".*", which allows any connection with a trusted certificate the ability to access the STS. This opens up the vulnerability for a client to "pretend" to be another client.
To prevent this, modify this property to be a list of regular expressions that map to the fully qualified hostnames of systems allowed to contact the STS.

===== Manage Users and Passwords
The default security configuration uses a property file located in `DDF_HOME/etc/user`.properties to store users and passwords.

The default Admin Console user is "admin" (no quotes) with a password of "admin" (no quotes). Change this password to a more secure password by editing this file.

.user.properties
----
Format:
USER=PASSWORD,ROLE1,ROLE2,....

Current default:
admin=admin,admin
----

===== Enable Password Encryption
In the {branding} Karaf command line console, enter the following commands:

.Enable Password Encryption
----
ddf@local> config:edit --force org.apache.karaf.jaas
ddf@local> config:propset encryption.enabled true
ddf@local> config:update
ddf@local> dev:restart
----

The passwords will then be encrypted in the `users.properties` file once {branding} restarts.

===== Known Issues
A system administrator must block visual access to the screen when administering passwords for particular components, such as the OpenSearch source. This is a known issue and will be addressed in a future version of {branding}.

=== Configuration Export/Import

The Configuration Export/Import capability allows administrators to export the current {branding} configuration and use it as a starting point for a new installation.

[IMPORTANT]
====
* Importing configuration files is only guaranteed to work when importing files from the same {branding} version.
  Importing from a different version is not recommended as it may cause the new {branding} instance to be incorrectly configured and become unusable.
* All configurations editable in the Admin Console will be exported to `<DDF_HOME>/etc/exported/etc`.
* All other configuration files (system configurations) will be put under `etc/exported` followed by their relative path from `DDF_HOME`.
  For instance, if a key store file was located under `<DDF_HOME>/keystores/keystore.jks`, it will be exported to `<DDF_HOME>/etc/exported/keystore/keystore.jks`.
* To keep the export/import process simple and consistent, all system configuration files are required to be under the `DDF_HOME` directory.
====

==== Export Configuration Settings

To export the current {branding} configuration:

. Using the {branding} Command Line Console, type in `platform:config-export`. This command creates the exported configuration files that are saved to `<DDF_HOME>/etc/exported`.
. Zip up the exported files in `<DDF_HOME>/etc/exported`
----
cd  <DDF_HOME>/etc/exported
zip exportedFiles.zip *
----

[IMPORTANT]
====
Some system configuration files contain paths to other configuration files. For instance, the `system.properties` file contains the `javax.net.ssl.keyStore`
property which provides the path to system key store.
The files referred to in the system configuration files will be included in the export process only if the path is relative to `DDF_HOME`.
Using absolute paths and or symbolic links in those cases will cause the `platform:config-export` command to display warnings about those files and exclude them from the export process.
The export process itself will not be aborted.
====


==== Import Configuration Settings

To import a previously exported configuration:

. Delete all exising `.config` files from `<DDF_HOME>/etc`: `rm <DDF_HOME>/etc/*.config`
. Unzip the exported files from a previous installation to the new instance's `<DDF_HOME>/etc` directory: `unzip exportedFiles.zip <DDF_HOME>/etc`
. If needed, manually update system configuration files such as `system.properties`, `users.properties`. keystores, etc.
. Launch the newly installed {branding}.
. Step through the installation process. The newly installed {branding} will have the previous {branding}'s settings imported.
. To get a status of the import, run the `platform:config-status` from the Command Line Console.


=== Starting {branding}

Follow the below steps to start and stop {branding}.

==== Start {branding}

===== *NIX

Run the following script from a command shell to start the distribution and open a local console:

----
DDF_INSTALL/bin/ddf
----

===== Windows

Run the following script from a console window to start the distribution and open a local console:

----
DDF_INSTALL/bin/ddf.bat
----

==== Stop {branding}
There are two options:

* Call shutdown from the console:

.Shut down with a prompt
----
ddf@local>shutdown
----

.Force Shutdown without prompt
----
ddf@local>shutdown -f
----

* Or run the stop script:

.*NIX
----
DDF_INSTALL/bin/stop
----

.Windows
----
DDF_INSTALL/bin/stop.bat
----

.Shut Down
[IMPORTANT]
====
Do not shut down by closing the window (Windows, Unix) or using the `kill -9 <pid>` command (Unix). This prevents a clean shutdown and can cause significant problems when
{branding} is restarted. Always use the shutdown command or the Ctrl-D shortcut (Windows) from the command line console.
====

==== Automatic Start on System Boot
Because {branding} is built on top of Apache Karaf, {branding} can use the Karaf Wrapper to enable automatic startup and shutdown.

. Create the Karaf wrapper.
+
.Within the {branding} console
----
ddf@local> features:install wrapper
ddf@local> wrapper:install -s AUTO_START -n ddf -d ddf -D "DDF Service"
----
+
. (Windows users skip to next step) (All *NIX) If {branding} was installed to run as a non-root user (recommended,) edit `DDF_INSTALL/bin/ddf-service`.
+
Change:
+
.{branding}_INSTALL/bin/ddf-service
----
#RUN_AS_USER=
----
+
to:
+
.{branding}_INSTALL/bin/ddf-service
----
RUN_AS_USER=<ddf-user>
----
+
. Set the memory in the wrapper config to match with {branding} default memory setting.
.. Add the setting for PermGen space under the JVM Parameters section.
.. Update heap space to 2048.
+
.{branding}_INSTALL/etc/ddf-wrapper.conf
[source,java,linenums]
----
#Add the following:
wrapper.java.additional.11=-Dderby.system.home="..\data\derby"
wrapper.java.additional.12=-Dderby.storage.fileSyncTransactionLog=true
wrapper.java.additional.13=-Dcom.sun.management.jmxremote
wrapper.java.additional.14=-Dfile.encoding=UTF8
wrapper.java.additional.15=-Dddf.home=%DDF_HOME%

#Update the following:
wrapper.java.maxmemory=2048
----
+
. Set the `DDF_HOME` property.
+
.{branding}_INSTALL/etc/ddf-wrapper.conf
----
set.default.DDF_HOME="%KARAF_HOME%"
----
+
. Install the wrapper startup/shutdown scripts.
+
*Windows*
+
Run the following command in a console window. The command must be run with elevated permissions.
+
----
DDF_INSTALL/bin/ddf-service.bat install
----
Startup and shutdown settings can then be managed through *Services MMC Start → Control Panel → Administrative Tools → Services*.
+
*Redhat*
+
----
root@localhost# ln -s DDF_INSTALL/bin/ddf-service /etc/init.d/
root@localhost# chkconfig ddf-service --add
root@localhost# chkconfig ddf-service on
----
+
*Ubuntu*
+
----
root@localhost# ln -s DDF_INSTALL/bin/ddf-service /etc/init.d/
root@localhost# update-rc.d -f ddf-service defaults
----
+
*Solaris*
+
----
root@localhost# ln -s DDF_INSTALL/bin/ddf-service /etc/init.d/
root@localhost# ln -s /etc/init.d/ddf-service /etc/rc0.d/K20ddf-service
root@localhost# ln -s /etc/init.d/ddf-service /etc/rc1.d/K20ddf-service
root@localhost# ln -s /etc/init.d/ddf-service /etc/rc2.d/K20ddf-service
root@localhost# ln -s /etc/init.d/ddf-service /etc/rc3.d/S20ddf-service
----
+
[WARNING]
====
While it is not a necessary step, information on how to convert the System V init scripts to the Solaris System Management Facility can be found at http://www.oracle.com/technetwork/articles/servers-storage-admin/scripts-to-smf-1641705.html
====
+
.Solaris-Specific Modification
[WARNING]
====
Due to a slight difference between the Linux and Solaris implementation of the ps command, the ddf-service script needs to be modified.
====
+
. Locate the following line in {branding}_INSTALL/bin/ddf-service
+
.Solaris {branding}_INSTALL/bin/ddf-service
----
pidtest=`$PSEXE -p $pid -o command | grep $WRAPPER_CMD | tail -1`
----
+
. Change the word command to comm.
+
.Solaris {branding}_Install/bin/ddf-service
----
pidtest=`$PSEXE -p $pid -o comm | grep $WRAPPER_CMD | tail -1`
----

===== Karaf Documentation

Because {branding} is built on Apache Karaf, more information on operating {branding} can be found in the Karaf documentation at http://karaf.apache.org/index/documentation.html.

=== Console Commands

Once the distribution has started, users will have access to a powerful command line console.
This text console can be used to manage services, install new features and applications, and manage the state of the system.

==== Access the System Console
The Command Line Shell Console is the console that is available to the user when the distribution is started manually.
It may also be accessed by using the `bin/client.bat` or `bin/client.sh` scripts.
For more information on how to use the `client` scripts or how to remote into the the shell console, see Using Remote Instances.

===== Example Commands

====== View Bundle Status
Call `osgi:list` on the console to view the status of the bundles loaded in the distribution.

====== View Installed Features
Execute `features:list` to view the features installed in the distribution.

[NOTE]
====
The majority of functionality and information available on the Admin Console is also available on the Command Line Shell Console.
====

==== Catalog Commands

[cols="1,1,8" options="header"]
|===
|Title
|Namespace
|Description

|DDF:: Catalog :: Core :: Commands
|catalog
|The Catalog Shell Commands are meant to be used with any CatalogProvider implementations. They provide general useful queries and functions against the Catalog API that can be used for debugging, printing, or scripting.

|===

[WARNING]
====
Most commands can bypass the Catalog framework and interact directly with the Catalog provider if given the --provider option, if available. No pre/post plugins are executed and no message validation is performed if the provider (--provider) option is used.
====

===== Commands

----
catalog:describe     catalog:dump         catalog:envlist      catalog:ingest       catalog:inspect
catalog:latest       catalog:migrate      catalog:range        catalog:remove       catalog:removeall
catalog:replicate    catalog:search       catalog:spatial
----

.Command Descriptions
[cols="1,9a" options="header"]
|===

|Command
|Description

|describe
|Provides a basic description of the Catalog implementation.

|dump
|Exports metacards from the local Catalog. Does not remove them. See below for date filtering options.

|envlist
|[IMPORTANT]
====
Deprecated as of ddf-catalog 2.5.0. Please use platform:envlist.
====

Provides a list of environment variables.

|ingest
|Ingests data files into the Catalog.

|inspect
|Provides the various fields of a metacard for inspection.

|latest
|Retrieves the latest records from the Catalog based on the Metacard.MODIFIED date.

|migrate
|Allows two CatalogProviders to be configured and migrates the data from the primary to the secondary.

|range
|Searches by the given range arguments (exclusively).

|remove
|Deletes a record from the local Catalog.

|removeall
|Attempts to delete all records from the local Catalog.

|replicate
|Replicates data from a federated source into the local Catalog.

|search
|Searches records in the local Catalog.

|spatial
|Searches spatially the local Catalog.

|===

===== Available System Console Commands
To get a list of commands, type in the namespace of the desired extension then press the *Tab* key.

For example, type catalog, then press *Tab*.

===== System Console Command Help

For details on any command, type help then the command.
For example, help search (see results of this command in the example below).

.Example Help
----
ddf@local>help search
DESCRIPTION
        catalog:search
        Searches records in the catalog provider.
SYNTAX
        catalog:search [options] SEARCH_PHRASE [NUMBER_OF_ITEMS]
ARGUMENTS
        SEARCH_PHRASE
                Phrase to query the catalog provider.
        NUMBER_OF_ITEMS
                Number of maximum records to display.
                (defaults to -1)
OPTIONS
        --help
                Display this help message
        case-sensitive, -c
                Makes the search case sensitive
        -p, -provider
                Interacts with the provider directly instead of the framework.

----

The `help` command provides a description of the provided command, along with the syntax in how to use it, arguments it accepts, and available options.

===== catalog:dump Options

The `catalog:dump` command was extended in {branding} version 2.5.0 to provide selective export of metacards based on date ranges.
The `--created-after` and `--created-before` options allow filtering on the date and time that the metacard was created, while `--modified-after` and `--modified-before` options allow filtering on the date and time that the metacard was last modified (which is the created date if no other modifications were made).
These date ranges are exclusive (i.e., if the date and time match exactly, the metacard will not be included).
The date filtering options (`--created-after`, `--created-before`, `--modified-after`, and `--modified-before`) can be used in any combination, with the export result including only metacards that match all of the provided conditions.

If no date filtering options are provided, created and modified dates are ignored, so that all metacards match.

===== Date Syntax

Supported dates are taken from the common subset of ISO8601, matching the datetime from the following syntax:
----
datetime          = time | date-opt-time
time              = 'T' time-element [offset]
date-opt-time     = date-element ['T' [time-element] [offset]]
date-element      = std-date-element | ord-date-element | week-date-element
std-date-element  = yyyy ['-' MM ['-' dd]]
ord-date-element  = yyyy ['-' DDD]
week-date-element = xxxx '-W' ww ['-' e]
time-element      = HH [minute-element] | [fraction]
minute-element    = ':' mm [second-element] | [fraction]
second-element    = ':' ss [fraction]
fraction          = ('.' | ',') digit+
offset            = 'Z' | (('+' | '-') HH [':' mm [':' ss [('.' | ',') SSS]]]
----

====== Examples

----
ddf@local>// Given we've ingested a few metacards
ddf@local>catalog:latest
#       ID                                Modified Date              Title
1       a6e9ae09c792438e92a3c9d7452a449f  2014-06-13T09:56:18+10:00
2       b4aced45103a400da42f3b319e58c3ed  2014-06-13T09:52:12+10:00
3       a63ab22361e14cee9970f5284e8eb4e0  2014-06-13T09:49:36+10:00  myTitle

ddf@local>// Filter out older files
ddf@local>catalog:dump --created-after 2014-06-13T09:55:00+10:00 /home/bradh/ddf-catalog-dump
 1 file(s) dumped in 0.015 seconds

ddf@local>// Filter out new file
ddf@local>catalog:dump --created-before 2014-06-13T09:55:00+10:00 /home/bradh/ddf-catalog-dump
 2 file(s) dumped in 0.023 seconds

ddf@local>// Choose middle file
ddf@local>catalog:dump --created-after 2014-06-13T09:50:00+10:00 --created-before 2014-06-13T09:55:00+10:00 /home/bradh/ddf-catalog-dump
 1 file(s) dumped in 0.020 seconds

ddf@local>// Modified dates work the same way
ddf@local>catalog:dump --modified-after 2014-06-13T09:50:00+10:00 --modified-before 2014-06-13T09:55:00+10:00 /home/bradh/ddf-catalog-dump
 1 file(s) dumped in 0.015 seconds

ddf@local>// Can mix and match, most restrictive limits apply
ddf@local>catalog:dump --modified-after 2014-06-13T09:45:00+10:00 --modified-before 2014-06-13T09:55:00+10:00 --created-before 2014-06-13T09:50:00+10:00 /home/bradh/ddf-catalog-dump
 1 file(s) dumped in 0.024 seconds

ddf@local>// Can use UTC instead of (or in combination with) explicit timezone offset
ddf@local>catalog:dump --modified-after 2014-06-13T09:50:00+10:00 --modified-before 2014-06-13T09:55:00Z /home/bradh/ddf-catalog-dump
 2 file(s) dumped in 0.020 seconds
ddf@local>catalog:dump --modified-after 2014-06-13T09:50:00+10:00 --modified-before 2014-06-12T23:55:00Z /home/bradh/ddf-catalog-dump
 1 file(s) dumped in 0.015 seconds

ddf@local>// Can leave off timezone, but default (local time on server) may not match what you expect!
ddf@local>catalog:dump --modified-after 2014-06-13T09:50:00 --modified-before 2014-06-13T09:55:00 /home/bradh/ddf-catalog-dump
 1 file(s) dumped in 0.018 seconds

ddf@local>// Can leave off trailing minutes / seconds
ddf@local>catalog:dump --modified-after 2014-06-13T09 --modified-before 2014-06-13T09:55 /home/bradh/ddf-catalog-dump
 2 file(s) dumped in 0.024 seconds

ddf@local>// Can use year and day number
ddf@local>catalog:dump --modified-after 2014-164T09:50:00 /home/bradh/ddf-catalog-dump
 2 file(s) dumped in 0.027 seconds
----

===== Known Command Issues

[cols="3,7" options="header"]
|===

|Issue
|Description

|Ingest more than 200,000 data files stored NFS shares may cause Java Heap Space error (Linux-only issue).
|This is an NFS bug where it creates duplicate entries for some files when doing a file list.  Depend on the OS,  some Linux machines can handle the bug better and able get a list of files but get an incorrect number of files. Others would have a Java Heap Space error because there are too many file to list.

|Ingest millions of complicated data into Solr can cause Java heap space error.
|Complicated data has spatial types and large text.

|Ingest serialized data file with scientific notation in WKT string causes RuntimeException.
|WKT string with scientific notation such as POINT (-34.8932113039107 -4.77974239601E-5) won't ingest. This occurs with serialized data format only.
|===

==== Command Scheduler

Command Scheduler is a capability exposed through the Admin Console (https://localhost:8993/admin) that allows administrators to schedule Command Line Shell Commands to be run at specified intervals.

===== Usage

The Command Scheduler allows administrators to schedule Command Line Shell Commands to be run in a "platform-independent" method.
For instance, if an administrator wanted to use the Catalog commands to export all records of a Catalog to a directory, the administrator could write a cron job or a scheduled task to remote into the container and execute the command.
Writing these types of scripts are specific to the administrator's operating system and also requires extra logic for error handling if the container is up.
The administrator can also create a Command Schedule, which currently requires only two fields.
The Command Scheduler only runs when the container is running, so there is no need to verify if the container is up.
In addition, when the container is restarted, the commands are rescheduled and executed again.

====== Schedule a Command

. Navigate to the Admin Console (https://localhost:8993/admin).
. Select {branding} Platform
. Select *Platform Command Scheduler*.
. Type the command or commands to be executed in the *Command* text field. Commands can be separated by a semicolon and will execute in order from left to right.
. Type in a positive integer for the *Interval In Seconds* field.
. Select the *Save* button. Once the *Save* button is selected, the command is executed immediately. It's next scheduled execution begins after the amount of seconds specified in the *Interval In Seconds* field and repeats indefinitely until the container is shut down or the scheduled command is deleted.

[NOTE]
====
Scheduled Commands can be updated and deleted. To delete, clear the fields and click save. To update, modify the fields and click Save.
====

====== Command Output
Commands that normally write out to the console will write out to the distribution's log. For example, if an `echo "Hello World"` command is set to run every five seconds, the log displays the following:

.Sample Command Output in the Log
----
16:01:32,582 | INFO  | heduler_Worker-1 | ddf.platform.scheduler.CommandJob          68 | platform-scheduler   | Executing command [echo Hello World]
16:01:32,583 | INFO  | heduler_Worker-1 | ddf.platform.scheduler.CommandJob          70 | platform-scheduler   | Execution Output: Hello World
16:01:37,581 | INFO  | heduler_Worker-4 | ddf.platform.scheduler.CommandJob          68 | platform-scheduler   | Executing command [echo Hello World]
16:01:37,582 | INFO  | heduler_Worker-4 | ddf.platform.scheduler.CommandJob          70 | platform-scheduler   | Execution Output: Hello World
----

In short, administrators can view the status of a run within the log as long as INFO was set as the status level.

==== Subscriptions Commands

[cols="3,1,6" options="header"]
|===

|Title
|Namespace
|Description

|{branding} :: Catalog :: Core :: PubSub Commands
|subscriptions
|The {branding} PubSub shell commands provide functions to list the registered subscriptions in

{branding} and to delete subscriptions.

|===

[WARNING]
====
The subscriptions commands are installed when the Catalog application is installed.
====

===== Commands

----
ddf@local>subscriptions:
subscriptions:delete    subscriptions:list
----

===== Command Descriptions

[cols="1,4" options="header"]
|===

|Command
|Description

|delete
|Deletes the subscription(s) specified by the search phrase or LDAP filter.

|list
|List the subscription(s) specified by the search phrase or LDAP filter.
|===

===== List Available System Console Commands
To get a list of commands, type the namespace of the desired extension the press the Tab key.

For example, type `subscriptions` then press *Tab*.

System Console Command Help
For details on any command type `help` then the subscriptions command.
For example, `help subscriptions:list` displays the data in the following table.

.Example Help
----
ddf@local>help subscriptions:list
DESCRIPTION
        subscriptions:list
        Allows users to view registered subscriptions.
SYNTAX
        subscriptions:list [options] [search phrase or LDAP filter]
ARGUMENTS
        search phrase or LDAP filter
                Subscription ID to search for. Wildcard characters (*) can be used in the ID, e.g., my*name or *123. If an id is not provided, then
                all of the subscriptions are displayed.
OPTIONS
        filter, -f
                Allows user to specify any type of LDAP filter rather than searching on single subscription ID.
                You should enclose the LDAP filter in quotes since it will often have special characters in it.
                An example LDAP filter would be:
                (& (subscription-id=my*) (subscription-id=*169*))
                which searches for all subscriptions starting with "my" and having 169 in the ID, which can be thought of as part of an IP address.
                An example of the entire quote command would be:
                subscriptions:list -f ""(& (subscription-id=my*) (subscription-id=*169*))"
        --help
                Display this help message
----

The `help` command provides a description of the command, along with the syntax on how to use it, arguments it accepts, and available options.

===== subscriptions:list Command Usage Examples

Note that no arguments are required for the `subscriptions:list` command. If no argument is provided, all subscriptions will be listed. A count of the subscriptions found matching the list command's search phrase (or LDAP filter) is displayed first followed by each subscription's ID.

====== List All Subscriptions

----
ddf@local>subscriptions:list

Total subscriptions found: 3

Subscription ID
my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
my.contextual.id.v30|http://172.18.14.169:8088/mockEventConsumerBinding?WSDL
my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification
----

====== List a Specific Subscription by ID

----
ddf@local>subscriptions:list "my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL"

Total subscriptions found: 1

Subscription ID
my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
----

[WARNING]
====
It is recommended to always quote the search phrase (or LDAP filter) argument to the command so that any special characters are properly processed.
====

====== List Subscriptions Using Wildcards

----
ddf@local>subscriptions:list "my*"

Total subscriptions found: 3

Subscription ID
my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
my.contextual.id.v30|http://172.18.14.169:8088/mockEventConsumerBinding?WSDL
my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification


ddf@local>subscriptions:list "*json*"

Total subscriptions found: 1

Subscription ID
my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification


ddf@local>subscriptions:list "*WSDL"

Total subscriptions found: 2

Subscription ID
my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
my.contextual.id.v30|http://172.18.14.169:8088/mockEventConsumerBinding?WSDL

----

====== List Subscriptions Using an LDAP Filter
The example below illustrates searching for any subscription that has "json" or "v20" anywhere in its subscription ID.

----
ddf@local>subscriptions:list -f "(|(subscription-id=*json*) (subscription-id=*v20*))"

Total subscriptions found: 2

Subscription ID
my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification
----

The example below illustrates searching for any subscription that has "json" and "172.18.14.169" in its subscription ID. This could be a handy way of finding all subscriptions for a specific site.

----
ddf@local>subscriptions:list -f "(&(subscription-id=*json*) (subscription-id=*172.18.14.169*))"

Total subscriptions found: 1

Subscription ID
my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification
----

===== `subscriptions:delete` Command Usage Example
The arguments for the `subscriptions:delete` command are the same as for the `list` command, except that a search phrase or LDAP filter must be specified. If one of these is not specified an error will be displayed.
When the `delete` command is executed it will display each subscription ID it is deleting. If a subscription matches the search phrase but cannot be deleted, a message in red will be displayed with the ID. After all matching subscriptions are processed, a summary line is displayed indicating how many subscriptions were deleted out of how many matching subscriptions were found.

====== Delete a Specific Subscription Using Its Exact ID

----
ddf@local>subscriptions:delete "my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification"

Deleted subscription for ID = my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification

Deleted 1 subscriptions out of 1 subscriptions found.
----

===== Delete Subscriptions Using Wildcards

[source,linenums]
----
ddf@local>subscriptions:delete "my*"

Deleted subscription for ID = my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
Deleted subscription for ID = my.contextual.id.v30|http://172.18.14.169:8088/mockEventConsumerBinding?WSDL

Deleted 2 subscriptions out of 2 subscriptions found.

ddf@local>subscriptions:delete "*json*"

Deleted subscription for ID = my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification

Deleted 1 subscriptions out of 1 subscriptions found.
----

===== Delete All Subscriptions

[source,linenums]
----
ddf@local>subscriptions:delete *

Deleted subscription for ID = my.contextual.id.v30|http://172.18.14.169:8088/mockEventConsumerBinding?WSDL
Deleted subscription for ID = my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
Deleted subscription for ID = my.contextual.id.json|http://172.18.14.169:8088/services/json/local/event/notification

Deleted 3 subscriptions out of 3 subscriptions found.
----

===== Delete Subscriptions Using an LDAP Filter

----
ddf@local>subscriptions:delete -f "(&(subscription-id=*WSDL) (subscription-id=*172.18.14.169*))"

Deleted subscription for ID = my.contextual.id.v20|http://172.18.14.169:8088/mockCatalogEventConsumerBinding?WSDL
Deleted subscription for ID = my.contextual.id.v30|http://172.18.14.169:8088/mockEventConsumerBinding?WSDL

Deleted 2 subscriptions out of 2 subscriptions found.
----

==== Platform Commands

[cols="2,1,7" options="header"]
|===

|Title
|Namespace
|Description

|{branding} Platform Commands
|platform
|The {branding} Platform Shell Commands provide generic platform management functions

|===

[WARNING]
====
The Platform Commands are installed when the Platform application is installed.
====

===== Commands

====== Command Descriptions

----
ddf@local>platform:
platform:config-export    platform:config-status    platform:describe    platform:envlist
----

[cols="2" options="header"]
|===

|Command
|Description

|config-export
|Exports the current configurations.

|config-status
|Lists import status of configuration files.

|describe
|Shows the current platform configuration.

|envlist
|Provides a list of environment variables.

|===

====== List Available System Console Commands

To view a list of commands, type the namespace of the desired extension and press the *Tab* key.

For example, type *platform* then press *Tab*.

===== System Console Command Help

For details on any command type `help` followed by the platform command.

For example, help `platform:envlist`

===== Example Help

----
ddf@local>help platform:envlist
DESCRIPTION
        platform:envlist

        Provides a list of environment variables

SYNTAX
        platform:envlist [options]

OPTIONS
        --help
                Display this help message
----

The `help` command provides a description of the provided command, along with the syntax in how to use it, arguments it accepts, and available options.

==== Persistence Commands

[cols="2,1,7" options="header"]
|===
|Title
|Namespace
|Description

|{branding}:: Persistence :: Core :: Commands
|store
|The Persistence Shell Commands are meant to be used with any PersistentStore implementations. They provide the ability to query and delete entries from the persistence store.

|===

===== Commands

----
store:delete    store:list
----

====== Command Descriptions

[cols="2,6"]
|===

|Command
|Description

|delete
|Delete entries from the persistence store that match a given CQL statement

|list
|Lists entries that are stored in the persistence store.

|===

====== Available System Console Commands
To get a list of commands, type in the namespace of the desired extension then press the *Tab* key.

For example, type _store_, then press *Tab*.

===== System Console Command Help
For details on any command, type help then the command. For example, help store:list (see results of this command in the example below).

====== Example Help

----
ddf@local>help store:list
DESCRIPTION
        store:list

    Lists entries that are available in the persistent store.

SYNTAX
        store:list [options]

OPTIONS
        User ID, -u, --user
                User ID to search for notifications. If an id is not provided, then all of the notifications for all users are displayed.
        --help
                Display this help message
        Persistence Type, -t, --type
                Type of item to retrieve from the persistence store.
                Options: metacard, saved_query, notification, task, or workspace
        CQL, -c, --cql
                OGC CQL statement to query the persistence store. Not specifying returns all entries. More information on CQL is available at:
                http://docs.geoserver.org/stable/en/user/tutorials/cql/cql_tutorial.html
----

The `help` command provides a description of the provided command, along with the syntax in how to use it, arguments it accepts, and available options.

==== CQL Syntax
The CQL syntax used should follow the OGC CQL format. Examples and a description of the grammar is located at http://docs.geoserver.org/stable/en/user/tutorials/cql/cql_tutorial.html.

===== Examples

----
Finding all notifications that were sent due to a download:
ddf@local>store:list --cql "application='Downloads'" --type notification

Deleting a specific notification:
ddf@local>store:delete --cql "id='fdc150b157754138a997fe7143a98cfa'" --type notification
----

=== Ingesting Data

Ingesting is the process of getting metadata into the Catalog Framework (including via the Content Framework).
Ingested files are "transformed" into a neutral format that can be search against as well as migrated to other formats and systems.
There are multiple methods available for ingesting files into the {branding}.

==== File types supported
{branding} supports a wide variety of file types and data types for ingest. The {branding}'s internal Input Transformers extract the necessary data into a generalized format. {branding} supports ingest of many datatypes and commonly use file formats, such as Microsoft office products: Word documents, Excel spreadsheets, and PowerPoint presentations as well as .pdf files, GeoJson and others.

==== Methods of Ingest

===== Easy (for fewer records or manual ingesting)

====== Ingest command (console)
The {branding} console application has a command line option for ingesting files

====== Usage
The syntax for the ingest command is "ingest" -t <transformer type> <file path relative to the installation path.

For XML data, run this command:
----
ingest -t xml examples/metacards/xml
----

====== Directory Monitor
The {branding} Content application contains a Directory Monitor feature that allows files placed in a single directory to be monitored and ingested automatically.
For more information about configuring a directory to be monitored, consult Directory Monitor.

====== Usage
Simply place the desired files in the monitored directory and it will be ingested automatically.
If, for any reason, the files cannot be ingested, they will be moved to an automatically created sub-folder named `.errors`.
Optionally, ingested files can be automatically moved to a sub-folder called `.ingested`.

===== Medium

====== External Methods
Several third-party tools, such as curl.exe and the Chrome Advanced Rest Client, can be used to send files and other types of data to {branding} for ingest.

===== Advanced (more records, automated ingest)
The {branding} provides endpoints for both REST and SOAP services, allowing integration with other data systems and the ability to further automate ingesting data into the catalog.
For further information, see Integrating Endpoints.

=== Metrics Reporting

Metrics are available in several formats and levels of detail.

Complete the following procedure now that several queries have been executed.

. Select DDF-Platform
. Select *Metrics* tab
. For individual metrics, choose the format desired from the desired timeframe column
.. PNG
.. CSV
.. XLS
. For a detailed report of all metrics, at the bottom of the page are selectors to choose time frame and summary level.

The report is made available in _xls_ format.

=== Troubleshooting

==== Exception Starting {branding} (Windows)

===== Problem:
An exception is sometimes thrown starting {branding} on a Windows machine (x86).

If using an unsupported terminal, java.lang.NoClassDefFoundError: Could not initialize class org.fusesource.jansi.internal.Kernel32 is thrown.

===== Solution:
Install missing Windows libraries.

Some Windows platforms are missing libraries that are required by {branding}.  These libraries are provided by the Microsoft Visual C++ 2008 Redistributable Package x64 (http://www.microsoft.com/en-us/download/details.aspx?id=15336).

==== CXF BusException

===== Problem:
The following exception is thrown:
`org.apache.cxf.BusException: No conduit initiator`

===== Solution:
Restart {branding}.
. Shut down {branding}: +
`ddf@local>shutdown`
. Start up {branding}:
`./ddf`

==== Distribution Will Not Start

===== Problem:
{branding} will not start when calling the start script defined during installation.

===== Solution:
Complete the following procedure.

. Verify that Java is correctly installed.
+
`java -version`
. This should return something similar to:
+
`java version "1.8.0_45" Java(TM) SE Runtime Environment (build 1.8.0_45-b14) Java HotSpot(TM) Server VM (build 25.45-b02, mixed mode)`
. If running *nix, verify that bash is installed.
+
`echo $SHELL`
. This should return:
+
`/bin/bash`

==== {branding} Is Unresponsive to Incoming Requests

===== Problem:
{branding} is unresponsive to incoming requests.

An example of the log file when this problem is encountered:

----
Feb 7, 2013 10:51:33 AM org.apache.karaf.main.SimpleFileLock lock
INFO: locking
Feb 7, 2013 10:51:33 AM org.apache.karaf.main.Main doLock
INFO: Waiting for the lock ...
Feb 7, 2013 10:51:33 AM org.apache.karaf.main.SimpleFileLock lock
INFO: locking
Feb 7, 2013 10:51:33 AM org.apache.karaf.main.Main doLock
INFO: Waiting for the lock ...
Feb 7, 2013 10:51:34 AM org.apache.karaf.main.SimpleFileLock lock
INFO: locking
Feb 7, 2013 10:51:34 AM org.apache.karaf.main.SimpleFileLock lock
INFO: locking
Feb 7, 2013 10:51:35 AM org.apache.karaf.main.SimpleFileLock lock
INFO: locking
Feb 7, 2013 10:51:35 AM org.apache.karaf.main.SimpleFileLock lock
INFO: locking
----

===== Symptoms
Multiple java.exe processes running, indicating more than one {branding} instance is running. This can be caused when another {branding} is not shut down.

===== Solutions:
Perform one or all of the following recommended solutions, as necessary.

* Wait for proper shutdown of {branding} prior to starting a new instance.
* Verify running java.exe are not {branding} (e.g., kill/close if necessary).
* Utilize automated start/stop scripts to run {branding} as a service.
